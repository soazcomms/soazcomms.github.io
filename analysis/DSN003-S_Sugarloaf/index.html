<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>ğŸ”¬ DSN Analysis</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta http-equiv="Cache-Control" content="no-store, max-age=0"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<style>
  :root{--barbg:#edf2f7}
  body{font:16px/1.4 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px;max-width:900px}
  h1{margin:0 0 8px 0}
  .muted{opacity:.75}
  .btn{display:inline-block;margin-top:10px;padding:8px 12px;border-radius:8px;border:1px solid #ccc;text-decoration:none}
  .btn[disabled]{opacity:.4;pointer-events:none}
  #barwrap{height:10px;width:50%;background:var(--barbg);border-radius:999px;overflow:hidden;margin:12px 0 4px 0;box-shadow:inset 0 0 0 1px #e2e8f0;margin-left:0;margin-right:auto}
  #bar{height:100%;width:0%;background:linear-gradient(90deg,#69c,#38bdf8 40%,#22c55e 75%,#16a34a 100%);transition:width .5s ease}
  #bar.timeout{background:linear-gradient(90deg,#f59e0b,#ef4444)}
</style>
</head>
<body>
  <h1 id="title">ğŸ”¬ DSN Analysis V.28</h1>
  <div id="header" class="muted">â³ Initializingâ€¦</div>

  <div id="barwrap"><div id="bar"></div></div>
  <div id="timersRow" class="muted">
    <span id="elapsed">0:00</span>
    <span> Â· Timeout in <span id="timeoutLeft">7:00</span></span>
  </div>

  <div id="status" class="row">Preparingâ€¦</div>
  <div class="row">
    <a id="viewBtn" class="btn" href="#" target="_blank" rel="noopener" disabled>ğŸ“„ View Analysis Result</a>
    <a class="btn" href="#" onclick="return closeTab(event)">ğŸ”™ Exit</a>
  </div>

<script>
(function(){
  // derive label8 from path: /analysis/<label8>/index.html
  const parts  = location.pathname.split("/").filter(Boolean);
  const label8 = parts[1] || "";
  const RAW  = "https://raw.githubusercontent.com/soazcomms/soazcomms.github.io/main/";
  const PGS  = "https://soazcomms.github.io/";
  const STATUS_URL = RAW + "status/status-" + encodeURIComponent(label8) + ".json";
  const FINAL_PGS  = PGS + "analysis/" + encodeURIComponent(label8) + "/" + encodeURIComponent(label8) + ".analysis.html";

  const titleEl  = document.getElementById("title");
  const headerEl = document.getElementById("header");
  const statusEl = document.getElementById("status");
  const viewBtn  = document.getElementById("viewBtn");
  const bar      = document.getElementById("bar");
  const elapsedEl = document.getElementById("elapsed");
  const leftEl    = document.getElementById("timeoutLeft");
  const timersRow = document.getElementById("timersRow");

  let DID_DONE=false, pollTimer=null, elapsedTimer=null, hardTimeout=null;
  const HARD_TIMEOUT_MS = 7*60*1000;
  const START = Date.now();

  function mmss(ms){ const s=Math.max(0,Math.floor(ms/1000)); return `${Math.floor(s/60)}:${String(s%60).padStart(2,"0")}`; }
  function tickTime(){
    const t = Date.now()-START;
    elapsedEl.textContent = mmss(t);
    const left = Math.max(0, HARD_TIMEOUT_MS - t);
    leftEl.textContent = mmss(left);
    bar.style.width = Math.min(99, Math.floor((t/HARD_TIMEOUT_MS)*100)) + "%";
    if (left===0) bar.classList.add("timeout");
  }
  function stopAllTimers(){ if(pollTimer){clearInterval(pollTimer);pollTimer=null;}
    if(elapsedTimer){clearInterval(elapsedTimer);elapsedTimer=null;}
    if(hardTimeout){clearTimeout(hardTimeout);hardTimeout=null;} }

  function cb(u){ return u + (u.includes("?")?"&":"?") + "_cb=" + Date.now(); }
  async function headOK(u){ try{ const r=await fetch(cb(u),{method:"HEAD",cache:"no-store"}); return r.ok; }catch{ return false; } }
  async function fetchStatus(){
    try{
      const r = await fetch(cb(STATUS_URL), { cache:"no-store" });
      if (!r.ok) return null;
      return await r.json();
    }catch{ return null; }
  }

  // UI boot
  document.title = `ğŸ”¬ DSN Analysis ${label8 ? "â€” "+label8 : ""}`;
  headerEl.textContent = "â³ Checking statusâ€¦";
  elapsedTimer = setInterval(tickTime, 1000); tickTime();
  hardTimeout = setTimeout(()=>{
    statusEl.textContent = "âŒ Timed out waiting for analysis.";
    bar.style.width = "100%";
    stopAllTimers();
  }, HARD_TIMEOUT_MS);

  async function doneUI(s){
    DID_DONE = true;
    stopAllTimers();
    bar.style.width = "100%";
    // Set header with site/range if present in status JSON
    const lab = s?.raw_label || label8;
    const from = s?.from || ""; const to = s?.to || "";
    headerEl.textContent = lab && from && to
      ? `Site: ${lab} Â· Range: ${from.split("T")[0] || from} â†’ ${to.split("T")[0] || to} â€” DONE`
      : (lab ? `Site: ${lab} â€” DONE` : "DONE");

    // Wait for Pages to serve final HTML, retry briefly
    for (let i=0;i<12;i++){ if (await headOK(FINAL_PGS)) break; await new Promise(r=>setTimeout(r,500)); }
    viewBtn.removeAttribute("disabled");
    viewBtn.href = cb(FINAL_PGS);
    statusEl.textContent = s?.status || "âœ… Analysis complete.";
    if (timersRow) timersRow.style.display = "none";
  }

  async function poll(){
    if (DID_DONE) return;
    const s = await fetchStatus();
    if (!s){ statusEl.textContent = "â³ Workingâ€¦"; return; }

    // show site/range as soon as we know them
    if (s.raw_label || s.from || s.to){
      const from = s.from ? (s.from.split("T")[0] || s.from) : "";
      const to   = s.to   ? (s.to.split("T")[0]   || s.to)   : "";
      headerEl.textContent = (s.raw_label && from && to)
        ? `Site: ${s.raw_label} Â· Range: ${from} â†’ ${to}`
        : (s.raw_label ? `Site: ${s.raw_label}` : headerEl.textContent);
    }

    if (/error/i.test(s.phase||"")){
      stopAllTimers();
      bar.style.width = "100%";
      statusEl.textContent = s.status || "âŒ Failed.";
      return;
    }
    if (/publishing/i.test(s.phase||"")){
      statusEl.textContent = "ğŸš€ Publishing resultsâ€¦";
      return;
    }
    if (/done/i.test(s.phase||"") || /âœ…/u.test(s.status||"")){
      await doneUI(s);
      return;
    }
    // default running
    statusEl.textContent = s.status || "â³ Running analysisâ€¦";
  }

  poll();
  pollTimer = setInterval(poll, 1200);

  // Exit behavior
  window.closeTab = function(e){
    if (e) e.preventDefault();
    try { window.close(); return false; } catch(_){}
    if (document.referrer){ location.replace(document.referrer); return false; }
    if (history.length>1){ history.back(); return false; }
    location.replace("https://soazcomms.grafana.net/");
    return false;
  };
})();
</script>
</body>
</html>
