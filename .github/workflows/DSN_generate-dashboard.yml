name: DSN_Analysis

on:
  workflow_dispatch:
    inputs:
      from:
        description: 'Start time (UTC, ISO format)'
        required: true
      to:
        description: 'End time (UTC, ISO format)'
        required: true
      label:
        description: 'DSN label (e.g. DSN014-S)'
        required: true
env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  BOX_CONFIG: ${{ secrets.BOX_CONFIG }}
  BOX_PATH: "DSNdata/BOX_ANALYSIS/"
  BOX_ARCHIVE_ID: "304428997491"

jobs:
  generate-dashboard:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Required Packages
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
 
      - name: Set up Python explicitly
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Confirm Python version
        run: |
          which python
          python --version
          ls -l $(which python)
    
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Box CLI
        run: |
          echo "Installing Box CLI via npm..."
          sudo apt-get update
          sudo apt-get install -y libsecret-1-dev
          npm install -g @box/cli
          box --version

      - name: Download Files from Box if needed
        env:
          LABEL: ${{ github.event.inputs.label }}
        run: |
          echo "$BOX_CONFIG" > box_config.json
          echo "Configure and upload to Box."
          box configure:environments:add box_config.json -n "github-box"
          box folders:items $BOX_ARCHIVE_ID --csv > results.csv
          BOX_FILES=$(awk -F',' -v label="$LABEL" '$0 ~ label { print $NF }' results.csv)
          echo "BOX_PATH is set to: ${BOX_PATH}"
          LOC_FILES=$(ls -p $BOX_PATH | grep -v '/$' | grep $LABEL)
          echo "LOC_FILES: $LOC_FILES"
          echo "BOX_FILES: $BOX_FILES"
          loc_tmp=$(mktemp)
          box_tmp=$(mktemp)

          echo "$LOC_FILES" | sort > "$loc_tmp"
          echo "$BOX_FILES" | sort > "$box_tmp"
          # Check for missing files
          MIS_FILES=$(comm -23 "$box_tmp" "$loc_tmp")
          if [ -z "$MIS_FILES" ]; then
            echo "✅ All files in ${BOX_PATH}. Skip Box download."
            exit 0
          fi
          echo "++++++++++ MIS_FILES: "$MIS_FILES" in ${BOX_PATH}"
          for box_file in $MIS_FILES; do
            box folders:items $BOX_ARCHIVE_ID --csv > results.csv
            box_ID=$(awk -F ',' -v fname="$box_file" 'NR > 1 && $9 == fname {print $2}' results.csv)
            echo "⬇️⬇️⬇️ Download Box File ID: $box_ID"
            box files:download "$box_ID" --destination $BOX_PATH -y
            echo "✅✅✅ Downloaded $box_ID"
          done

      - name: Generate 5-plot dashboard
        run: |
          python .github/scripts/DSN_generate_5_plots.py  --input_dir "$BOX_PATH" --from "${{ github.event.inputs.from }}"  --to "${{ github.event.inputs.to }}"    --label "${{ github.event.inputs.label }}" --output "dashboard.html"

      - name: Deploy to GitHub Pages (gh-pages branch)
        run: |
          mkdir -p public
          cp dashboard.html public/index.html

      - name: Upload to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
