name: DSN-get-SQM-Box Data

on:
  schedule:
    - cron: '0 8 2 * *'  # Runs at 08:00 UTC every Tuesday
  workflow_dispatch:  # Allows manual triggering

env:
  CLBOX_CONFIG: ${{ secrets.CLBOX_CONFIG }}
  BOX_CONFIG: ${{ secrets.BOX_CONFIG }}
  NEW_PATH: "DSNdata/NEW/"
  MERGE_PATH: "DSNdata/MERGE/"
  SQMTABLE_CSV: "DSNdata/SQMtable.csv"
  LOG_FILE: "DSNdata/SQMdownloaded.log"

jobs:
  sync-sqm-data:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libgtk-3-dev libc-bin curl
          pip install --upgrade pip
          pip install pandas
          sudo apt-get install -y rclone

      - name: Configure rclone for Box DOWNLOAD
        run: |
          mkdir -p ~/.config/rclone
          echo "$CLBOX_CONFIG" > ~/.config/rclone/rclone.conf
#          rclone listremotes  # Verify connection

#      - name: Check Required Files and Directories
#        run: |
#          touch "$LOG_FILE"

      - name: Process each site in SQMtable.csv
        run: |
          if [ ! -f "$SQMTABLE_CSV" ]; then
            echo "Error: SQMtable.csv not found!" >&2
            exit 1
          fi
          rm -rf cleaned_sqm.csv
          Box_list="CFh MtL V06 CCn"  # Box data aliases
          while IFS=, read -r site_name sequence alias; do
            if [ "$alias" == "Alias" ]; then  # skip first, header line
              continue
            fi
            if [[ $Box_list =~ $alias ]]; then # OK if in list
              echo "$alias" >> cleaned_sqm.csv
            fi
          done < "$SQMTABLE_CSV"
          echo "---- Processing each Box site in cleaned_sqm.csv:"
          cat cleaned_sqm.csv

          while IFS=, read -r site_name sequence alias; do
            echo "---- Processing Site: $site_name (Seq: $sequence) Alias: $alias"
            SITE_FOLDER="boxshared:SQM/$alias"
            LOCAL_FOLDER="DSNdata/$site_name"
            mkdir -p "$LOCAL_FOLDER"

            echo "Checking for new .csv files in $SITE_FOLDER..."
            rclone lsf "$SITE_FOLDER" | grep "2....csv" > available_files.txt || true

            if [ -f "$LOG_FILE" ]; then
              grep -Fxvf "$LOG_FILE" available_files.txt > new_files.txt || true
            else
              mv available_files.txt new_files.txt
            fi
            # new_files.txt has names only of files not yet downloaded
            if [ -s new_files.txt ]; then
              echo "Downloading new files..."
              while IFS= read -r bfile; do
                if [[ -n "$bfile" ]]; then
                  echo "Downloading: $bfile"
                  rclone copy $SITE_FOLDER/$bfile "$LOCAL_FOLDER" --progress
                  echo "$bfile" >> "$LOG_FILE"
                else
                  echo "Warning: Empty filename encountered, skipping."
                fi
              done < new_files.txt
              # rewrite files in standard format
              python DSNrename_Box_files.py "$LOCAL_FOLDER" "$SQMTABLE_CSV"
              # leave them ready for SQM processing workflow
              for bfile in "$LOCAL_FOLDER"/*; do
                if [ -f "$bfile" ]; then
                  mv "$bfile" "$NEW_PATH"
                  echo "Moved $bfile to $NEW_PATH"
                fi
              done
            else
              echo "No new files for $site_name, skipping."
            fi
          done < cleaned_sqm.csv

      - name: Commit Updated Log and SQMtable.csv
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$LOG_FILE" "$SQMTABLE_CSV" "$NEW_PATH"
          if git diff-index --quiet HEAD; then
            echo "No changes to commit."
          else
            git commit -m "Updated log file and SQMtable.csv with new sequence numbers"
            git push
          fi

      - name: Upload Files to Box
        run: |
          echo "$BOX_CONFIG" > box_config.json
          echo "NEW_PATH is set to: ${NEW_PATH}"

          IN_FILES=$(ls -1 "${NEW_PATH}")
          if [ "$IN_FILES" ]; then
             echo "Configure and upload $IN_FILES to Box."
            box configure:environments:add box_config.json -n "github-box"
          else
            echo "Warning: No files found in ${NEW_PATH}"
          fi
          for file in $IN_FILES; do
           # Extract Box File ID from CSV
            box folders:items $BOX_SQM_ID --csv > results.csv
            box_ID=$(awk -F ',' -v fname="$file" 'NR > 1 && $9 == fname {print $2}' results.csv)
            echo "Extracted Box ID: '$box_ID'"
            if [ -z "$box_ID" ] || [ "$box_ID" == "null" ]; then
              box files:upload $NEW_PATH"$file" -p $BOX_SQM_ID -y -q
              echo "⬆️⬆️⬆️ Uploaded $file"
            else
              echo "❌❌❌ $file already in Box, no upload."
            fi
          done

      - name: Commit Changes to Repository
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add DSNdata
          if git diff-index --quiet HEAD; then
            echo "No changes to commit."
          else
            git commit -m "Updated DSNdata"
            git push
          fi
