name: DSN Analysis

on:
  workflow_dispatch:
    inputs:
      label:
        description: "Full label (e.g. DSN019-S_MtLemmon)"
        required: true
      from:
        description: "Start (YYYY-MM-DD HH:MM:SS)"
        required: true
      to:
        description: "End (YYYY-MM-DD HH:MM:SS)"
        required: true

permissions:
  contents: write
  pages: write

concurrency:
  # one run at a time per site (prevents overlap from multiple clicks)
  group: dsn-${{ github.event.inputs.label }}
  cancel-in-progress: false

jobs:
  dsn:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    env:
      # Influx config used by both CSV + Analysis scripts
      INFLUX_URL:   https://us-east-1-1.aws.cloud2.influxdata.com
      INFLUX_TOKEN: ${{ secrets.INFLUX_TOKEN }}
      LABEL: ${{ github.event.inputs.label }}
      FROM:  ${{ github.event.inputs.from }}
      TO:    ${{ github.event.inputs.to }}
      SITE_REPO: ${{ github.workspace }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Derive date yyyymmdd
        id: derive
        shell: bash
        run: |
          set -euo pipefail
          FROMD="$(date -d "${FROM}" +%Y%m%d)"
          TOD="$(date -d "${TO}" +%Y%m%d)"
          echo "FROMD=${FROMD}"   >> $GITHUB_OUTPUT
          echo "TOD=${TOD}"       >> $GITHUB_OUTPUT
          echo "Label: $LABEL ($FROMD..$TOD)"

      - name: Setup Python
        uses: actions/setup-python@v5
        with: { python-version: "3.11" }

      - name: Install Python deps (best effort)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt || true; fi

      - name: "Write status: running"
        run: |
          set -e
          mkdir -p status analysis/"${LABEL}"

          STATUS_FILE="status/status-${LABEL}.json"

          printf '%s\n' \
          "{" \
          "  \"timestamp\": $(date +%s)," \
          "  \"phase\": \"running\"," \
          "  \"status\": \"â³ Running analysis for ${LABEL}...\"," \
          "  \"raw_label\": \"${LABEL}\"" \
          "}" > "${STATUS_FILE}"

      - name: Ensure CSV exists (recreate if missing or wrong range)
        shell: bash
        run: |
          set -euo pipefail

          FROMD="${{ steps.derive.outputs.FROMD }}"
          TOD="${{ steps.derive.outputs.TOD }}"

          OUTDIR="analysis/${LABEL}"
          CSV="${OUTDIR}/${LABEL}_${FROMD}_${TOD}.csv"

          echo "LABEL=${LABEL}"
          echo "FROM=${FROM}"
          echo "TO=${TO}"
          echo "FROMD=${FROMD}"
          echo "TOD=${TOD}"
          echo "OUTDIR=${OUTDIR}"
          echo "CSV=${CSV}"
          echo "GITHUB_WORKSPACE=${GITHUB_WORKSPACE}"
          echo "INFLUX_URL=${INFLUX_URL}"

          need_csv=1
          if [ -f "${CSV}" ] && [ -s "${CSV}" ]; then
            echo "Reusing existing ${CSV}"
            need_csv=0
          fi

          if [ $need_csv -eq 1 ]; then
            echo "Generating CSV -> ${CSV}"
            mkdir -p "${OUTDIR}"

            set +e
            python DSN_generate_csv.py \
              --label        "${LABEL}" \
              --from         "${FROM}" \
              --to           "${TO}" \
              --site-repo    "${GITHUB_WORKSPACE}" \
              --influx-url   "${INFLUX_URL}" \
              --influx-token "${INFLUX_TOKEN}" \
              --out          "${CSV}" \
              > /tmp/dsn_csv.log 2>&1
            rc=$?
            set -e

            echo "DSN_generate_csv.py exit code: $rc"
            echo "------ /tmp/dsn_csv.log ------"
            cat /tmp/dsn_csv.log || echo "(no log output)"
            echo "------------------------------"

            if [ $rc -ne 0 ]; then
              echo "âŒ DSN_generate_csv.py failed; see log above."
              exit $rc
            fi

            if [ ! -s "${CSV}" ]; then
              echo "âŒ CSV generation failed: file is empty or missing"
              exit 1
            fi
          fi

      - name: Run analysis (produces HTML and panels)
        shell: bash
        run: |
          set -euo pipefail
          python DSN_generate_analysis.py \
            --label     "${LABEL}" \
            --from      "${FROM}" \
            --to        "${TO}" \
            --input_dir "analysis/${LABEL}"

          echo "Listing outputs:"
          ls -l "analysis/${LABEL}"

      - name: Install endpoint HTML (per-label landing page)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "analysis/${LABEL}"
          # Copy uploaded template into the label's folder as index.html
          cp -f tools/DSN_endpoint.html "analysis/${LABEL}/index.html"
          echo "Endpoint ready at analysis/${LABEL}/index.html"

      - name: "Write status: publishing"
        run: |
          set -e
          mkdir -p status analysis/"${LABEL}"

          FINAL_REL="analysis/${LABEL}/${LABEL}.analysis.html"
          test -f "${FINAL_REL}" || { echo "Missing ${FINAL_REL}"; exit 1; }

          STATUS_FILE="status/status-${LABEL}.json"

          printf '%s\n' \
          "{" \
          "  \"timestamp\": $(date +%s)," \
          "  \"phase\": \"publishing\"," \
          "  \"status\": \"ðŸš€ Publishing results for ${LABEL}...\"," \
          "  \"raw_label\": \"${LABEL}\"" \
          "}" > "${STATUS_FILE}"

       - name: "Write status: done and push"
         run: |
           set -e
           mkdir -p status analysis/"${LABEL}"

           FINAL_REL="analysis/${LABEL}/${LABEL}.analysis.html"
           PUBLIC_URL="https://soazcomms.github.io/${FINAL_REL}"

           test -f "${FINAL_REL}" || { echo "Missing ${FINAL_REL}"; exit 1; }

           STATUS_FILE="status/status-${LABEL}.json"

           printf '%s\n' \
           "{" \
           "  \"timestamp\": $(date +%s)," \
           "  \"phase\": \"done\"," \
           "  \"status\": \"âœ… Analysis complete for ${LABEL}\"," \
           "  \"html\": \"${PUBLIC_URL}\"," \
           "  \"raw_label\": \"${LABEL}\"" \
           "}" > "${STATUS_FILE}"

           git add "${STATUS_FILE}" "analysis/${LABEL}"

           if ! git diff --cached --quiet; then
             git -c user.name="actions" -c user.email="actions@users.noreply.github.com" \
               commit -m "[analysis] ${LABEL} complete"
             git push origin HEAD:main
           else
             echo "No changes to commit."
           fi

      - name: Wait for GitHub Pages to serve final HTML
        shell: bash
        run: |
          FINAL="https://soazcomms.github.io/analysis/${LABEL}/${LABEL}.analysis.html"
          echo "Waiting for ${FINAL}"
          end=$((SECONDS+60))
          ok=0
          while [ $SECONDS -lt $end ]; do
            code=$(curl -s -o /dev/null -w "%{http_code}" -H "Cache-Control: no-cache" -I "${FINAL}?_cb=$(date +%s%3N)")
            if [ "$code" = "200" ]; then ok=1; break; fi
            sleep 1
          done
          if [ $ok -ne 1 ]; then
            echo "WARNING: Pages not ready within timeout (status is already 'done')."
          fi