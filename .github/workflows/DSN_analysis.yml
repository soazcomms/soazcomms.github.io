name: DSN Analysis

on:
  workflow_dispatch:
    inputs:
      label:
        description: "Full label (e.g. DSN019-S_MtLemmon)"
        required: true
      from:
        description: "Start (YYYY-MM-DD HH:MM:SS)"
        required: true
      to:
        description: "End (YYYY-MM-DD HH:MM:SS)"
        required: true

permissions:
  contents: write
  pages: write

concurrency:
  # one run at a time per site (prevents overlap from multiple clicks)
  group: dsn-${{ github.event.inputs.label }}
  cancel-in-progress: false

jobs:
  dsn:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    env:
      # Influx config used by both CSV + Analysis scripts
      INFLUX_URL:   https://us-east-1-1.aws.cloud2.influxdata.com
      INFLUX_TOKEN: ${{ secrets.INFLUX_TOKEN }}
      LABEL: ${{ github.event.inputs.label }}
      FROM:  ${{ github.event.inputs.from }}
      TO:    ${{ github.event.inputs.to }}
      SITE_REPO: ${{ github.workspace }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "Remove stale status file (no commit yet)"
        run: |
          rm -f status/status-${LABEL}.json || true

      - name: Derive date yyyymmdd
        id: derive
        shell: bash
        run: |
          set -euo pipefail
          FROMD="$(date -d "${FROM}" +%Y%m%d)"
          TOD="$(date -d "${TO}" +%Y%m%d)"
          echo "FROMD=${FROMD}"   >> "$GITHUB_OUTPUT"
          echo "TOD=${TOD}"       >> "$GITHUB_OUTPUT"
          echo "Label: $LABEL ($FROMD..${TOD})"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "requirements.txt"

      - name: Install Python deps (best effort)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt || true
          fi

      - name: "Write status: running"
        run: |
          set -e
          mkdir -p status analysis/"${LABEL}"

          STATUS_FILE="status/status-${LABEL}.json"

          printf '%s\n' \
          "{" \
          "  \"timestamp\": $(date +%s)," \
          "  \"phase\": \"running\"," \
          "  \"status\": \"‚è≥ Running analysis for ${LABEL}...\"," \
          "  \"raw_label\": \"${LABEL}\"" \
          "}" > "${STATUS_FILE}"

      - name: Ensure CSV exists (recreate if missing or wrong range)
        shell: bash
        run: |
          set -euo pipefail

          FROMD="${{ steps.derive.outputs.FROMD }}"
          TOD="${{ steps.derive.outputs.TOD }}"

          OUTDIR="analysis/${LABEL}"
          CSV="${OUTDIR}/${LABEL}_${FROMD}_${TOD}.csv"
          LOG="${OUTDIR}/${LABEL}_${FROMD}_${TOD}.log"

          echo "LABEL=${LABEL}"
          echo "FROM=${FROM}"
          echo "TO=${TO}"
          echo "FROMD=${FROMD}"
          echo "TOD=${TOD}"
          echo "OUTDIR=${OUTDIR}"
          echo "CSV=${CSV}"
          echo "GITHUB_WORKSPACE=${GITHUB_WORKSPACE}"
          echo "INFLUX_URL=${INFLUX_URL}"

          need_csv=1
          if [ -f "${CSV}" ] && [ -s "${CSV}" ]; then
            echo "Reusing existing ${CSV}"
            need_csv=0
          fi

          if [ $need_csv -eq 1 ]; then
            echo "Generating CSV -> ${CSV}"
            mkdir -p "${OUTDIR}"

            set +e
            python DSN_generate_csv.py \
              --label        "${LABEL}" \
              --from         "${FROM}" \
              --to           "${TO}" \
              --site-repo    "${GITHUB_WORKSPACE}" \
              --influx-url   "${INFLUX_URL}" \
              --influx-token "${INFLUX_TOKEN}" \
              --out          "${CSV}" \
              > "${LOG}" 2>&1
            rc=$?
            set -e

            echo "DSN_generate_csv.py exit code: $rc"
            echo "------ ${LOG} ------"
            cat "${LOG}" || echo "(no log output)"
            echo "------------------------------"

            if [ $rc -ne 0 ]; then
              echo "‚ùå DSN_generate_csv.py failed; see log above."
              exit $rc
            fi

            if [ ! -s "${CSV}" ]; then
              echo "‚ùå CSV generation failed: file is empty or missing"
              exit 1
            fi
          fi

      - name: Run analysis (produces HTML and panels)
        shell: bash
        run: |
          set -euo pipefail

          FROMD="${{ steps.derive.outputs.FROMD }}"
          TOD="${{ steps.derive.outputs.TOD }}"

          OUTDIR="analysis/${LABEL}"
          MARKER="${OUTDIR}/files_${FROMD}_${TOD}"

          echo "Expected marker for this range: ${MARKER}"

          need_files=1
          if [ -f "${MARKER}" ]; then
            echo "Marker exists for this range; reusing existing analysis outputs."
            need_files=0
          fi

          if [ $need_files -eq 1 ]; then
            echo "Marker not found; running DSN_generate_analysis.py"
            python DSN_generate_analysis.py \
              --label     "${LABEL}" \
              --from      "${FROM}" \
              --to        "${TO}" \
              --input_dir "${OUTDIR}"
          else
            echo "Skipping DSN_generate_analysis.py (files_* already in place)."
          fi

          echo "Listing outputs in ${OUTDIR}:"
          ls -l "${OUTDIR}"

      - name: Install endpoint HTML (per-label landing page)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "analysis/${LABEL}"
          # Copy uploaded template into the label's folder as index.html
          cp -f tools/DSN_endpoint.html "analysis/${LABEL}/index.html"
          echo "Endpoint ready at analysis/${LABEL}/index.html"

      - name: "Write status: publishing"
        run: |
          set -e
          mkdir -p status analysis/"${LABEL}"

          FINAL_REL="analysis/${LABEL}/${LABEL}.analysis.html"
          test -f "${FINAL_REL}" || { echo "Missing ${FINAL_REL}"; exit 1; }

          STATUS_FILE="status/status-${LABEL}.json"

          printf '%s\n' \
          "{" \
          "  \"timestamp\": $(date +%s)," \
          "  \"phase\": \"publishing\"," \
          "  \"status\": \"üöÄ Publishing results for ${LABEL}...\"," \
          "  \"raw_label\": \"${LABEL}\"" \
          "}" > "${STATUS_FILE}"

      - name: Upload Analysis Results as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: analysis-${{ env.LABEL }}-${{ steps.derive.outputs.FROMD }}-${{ steps.derive.outputs.TOD }}
          path: |
            analysis/${{ env.LABEL }}/*.html
            analysis/${{ env.LABEL }}/*.csv
            analysis/${{ env.LABEL }}/*.log
            analysis/${{ env.LABEL }}/*.png
            analysis/${{ env.LABEL }}/*.json
            analysis/${{ env.LABEL }}/files_*
          retention-days: 90
          if-no-files-found: error

      - name: "Write status: done and push"
        run: |
          set -e
          mkdir -p status analysis/"${LABEL}"

          FINAL_REL="analysis/${LABEL}/${LABEL}.analysis.html"
          PUBLIC_PATH="/analysis/${LABEL}/${LABEL}.analysis.html"
          test -f "${FINAL_REL}" || { echo "Missing ${FINAL_REL}"; exit 1; }

          STATUS_FILE="status/status-${LABEL}.json"

          printf '%s\n' \
          "{" \
          "  \"timestamp\": $(date +%s)," \
          "  \"phase\": \"done\"," \
          "  \"status\": \"‚úÖ Analysis complete for ${LABEL}\"," \
          "  \"html\": \"${PUBLIC_PATH}\"," \
          "  \"raw_label\": \"${LABEL}\"" \
          "}" > "${STATUS_FILE}"

          git config user.name "actions"
          git config user.email "actions@users.noreply.github.com"

          git add "${STATUS_FILE}" "analysis/${LABEL}"

          if ! git diff --cached --quiet; then
            git commit -m "[analysis] ${LABEL} complete"

            # Retry push a few times in case main moved
            max_tries=3
            n=1
            while [ $n -le $max_tries ]; do
              if git push origin HEAD:main; then
                echo "‚úÖ Push succeeded."
                break
              fi
              echo "Push failed (attempt $n); pulling latest and retrying..."
              git pull --rebase origin main || true
              n=$((n+1))
              sleep 2
            done

            if [ $n -gt $max_tries ]; then
              echo "‚ùå ERROR: Failed to push after ${max_tries} attempts."
              exit 1
            fi
          else
            echo "No changes to commit."
          fi
