name: DSN Analysis

on:
  workflow_dispatch:
    inputs:
      label:
        description: "Full label (e.g. DSN019-S_MtLemmon)"
        required: true
      from:
        description: "Start (YYYY-MM-DD HH:MM:SS)"
        required: true
      to:
        description: "End (YYYY-MM-DD HH:MM:SS)"
        required: true

permissions:
  contents: write
  pages: write

concurrency:
  # one run at a time per site (prevents overlap from multiple clicks)
  group: dsn-${{ github.event.inputs.label }}
  cancel-in-progress: false

jobs:
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    env:
      LABEL: ${{ github.event.inputs.label }}
      FROM:  ${{ github.event.inputs.from }}
      TO:    ${{ github.event.inputs.to }}
      SITE_REPO: ${{ github.workspace }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Derive LABEL8 and date yyyymmdd
        id: derive
        shell: bash
        run: |
          set -euo pipefail
          RAW_LABEL="${LABEL}"
          LABEL8="$(printf "%s" "${RAW_LABEL%%_*}" | cut -c1-8)"
          FROMD="$(date -d "${FROM}" +%Y%m%d)"
          TOD="$(date -d "${TO}" +%Y%m%d)"
          echo "LABEL8=${LABEL8}" >> $GITHUB_OUTPUT
          echo "FROMD=${FROMD}"   >> $GITHUB_OUTPUT
          echo "TOD=${TOD}"       >> $GITHUB_OUTPUT
          echo "Label: $RAW_LABEL -> $LABEL8 ($FROMD..$TOD)"

      - name: Setup Python
        uses: actions/setup-python@v5
        with: { python-version: "3.11" }

      - name: Install Python deps (best effort)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt || true; fi

      - name: "Write status: running"
        run: |
          set -e
          mkdir -p status analysis/${{ steps.derive.outputs.LABEL8 }}
          cat > status/status-${{ steps.derive.outputs.LABEL8 }}.json <<EOF
          {"timestamp": $(date +%s), "phase": "running", "status": "â³ Running analysis for ${LABEL}...", "raw_label": "${LABEL}"}
          EOF
          git add status/status-${{ steps.derive.outputs.LABEL8 }}.json
          git -c user.name="actions" -c user.email="actions@users.noreply.github.com" commit -m "[status] ${{ steps.derive.outputs.LABEL8 }} running" || true
          git push origin HEAD:main

      - name: Clean non-CSV outputs for this label8
        run: |
          shopt -s nullglob
          for f in analysis/${{ steps.derive.outputs.LABEL8 }}/*; do
            case "$f" in
              *.csv) : ;;
              *) rm -f "$f" ;;
            esac
          done

      - name: Ensure CSV exists (recreate if missing or wrong range)
        shell: bash
        run: |
          set -euo pipefail
          LABEL8="${{ steps.derive.outputs.LABEL8 }}"
          FROM="${{ github.event.inputs.from }}"
          TO="${{ github.event.inputs.to }}"
          FROMD="${{ steps.derive.outputs.FROMD }}"
          TOD="${{ steps.derive.outputs.TOD }}"
          OUTDIR="analysis/${LABEL8}"
          CSV="${OUTDIR}/${LABEL}_${FROMD}_${TOD}.csv"

          need_csv=1
          if [ -f "${CSV}" ] && [ -s "${CSV}" ]; then
            echo "Reusing existing ${CSV}"
            need_csv=0
          fi

          if [ $need_csv -eq 1 ]; then
            echo "Generating CSV -> ${CSV}"
            mkdir -p "${OUTDIR}"
            # Your script supports a CSV-only mode per our earlier work
            python DSN_generate_csv.py \
              --label "${LABEL}" --from "${FROM}" --to "${TO}" \
              --site-repo "$GITHUB_WORKSPACE" \
              --out "${CSV}" 
            test -s "${CSV}" || { echo "CSV generation failed"; exit 1; }
          fi

      - name: Run analysis (produces ${LABEL8}.analysis.html + panels)
        run: |
          python DSN_generate_analysis.py \
            --label "${LABEL}" --from "${FROM}" --to "${TO}" \
            --input_dir "analysis/${{ steps.derive.outputs.LABEL8 }}"

      - name: Install endpoint HTML (per-label landing page)
        shell: bash
        run: |
          set -euo pipefail
          LABEL8="${{ steps.derive.outputs.LABEL8 }}"
          mkdir -p "analysis/${LABEL8}"
          # Copy your uploaded template into the label's folder as index.html
          cp -f tools/DSN_endpoint.html "analysis/${LABEL8}/index.html"
          echo "Endpoint ready at analysis/${LABEL8}/index.html"

      - name: "Write status: publishing and push artifacts"
        run: |
          FINAL_REL="analysis/${{ steps.derive.outputs.LABEL8 }}/${{ steps.derive.outputs.LABEL8 }}.analysis.html"
          test -f "${FINAL_REL}" || { echo "Missing ${FINAL_REL}"; exit 1; }
          cat > status/status-${{ steps.derive.outputs.LABEL8 }}.json <<EOF
          {"timestamp": $(date +%s), "phase": "publishing", "status": "ğŸš€ Publishing results to Git for ${LABEL}â€¦", "raw_label": "${LABEL}"}
          EOF
          git add analysis/${{ steps.derive.outputs.LABEL8 }} status/status-${{ steps.derive.outputs.LABEL8 }}.json
          git -c user.name="actions" -c user.email="actions@users.noreply.github.com" commit -m "[analysis] ${{ steps.derive.outputs.LABEL8 }} update" || true
          git push origin HEAD:main

      - name: Wait for GitHub Pages to serve final HTML
        shell: bash
        run: |
          LABEL8="${{ steps.derive.outputs.LABEL8 }}"
          FINAL="https://soazcomms.github.io/analysis/${LABEL8}/${LABEL8}.analysis.html"
          echo "Waiting for ${FINAL}"
          end=$((SECONDS+90))
          ok=0
          while [ $SECONDS -lt $end ]; do
            code=$(curl -s -o /dev/null -w "%{http_code}" -H "Cache-Control: no-cache" -I "${FINAL}?_cb=$(date +%s%3N)")
            if [ "$code" = "200" ]; then ok=1; break; fi
            sleep 1
          done
          if [ $ok -ne 1 ]; then
            echo "WARNING: Pages not ready within timeout (will still flip status to done)"
          fi

      - name: "Write status: done (status-only push)"
        run: |
          FINAL_REL="analysis/${{ steps.derive.outputs.LABEL8 }}/${{ steps.derive.outputs.LABEL8 }}.analysis.html"
          cat > status/status-${{ steps.derive.outputs.LABEL8 }}.json <<EOF
          {"timestamp": $(date +%s), "phase": "done", "status": "âœ… Analysis complete for ${LABEL}", "html": "${FINAL_REL}", "raw_label": "${LABEL}"}
          EOF
          git add status/status-${{ steps.derive.outputs.LABEL8 }}.json
          git -c user.name="actions" -c user.email="actions@users.noreply.github.com" commit -m "[status] ${{ steps.derive.outputs.LABEL8 }} done" || true
          git push origin HEAD:main