<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üî¨ DSN Analysis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --primary:#007bff; --accent:#87CEFA; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; text-align:center; margin:2rem; }
    h2 { margin-bottom:.25rem; }
    #status { margin:.5rem 0 0.25rem; font-size:1.05rem; }
    #timer { color:#555; margin:.25rem 0 1rem; font-size:.95rem; }
    a.button {
      display:none; margin-top:.5rem; padding:.6rem 1.2rem; font-size:1rem;
      background:var(--primary); color:#fff; text-decoration:none; border-radius:8px;
    }
    button#exit-btn {
      margin-top:1rem; padding:.6rem 1.2rem; font-size:1rem;
      background:var(--accent); border:0; border-radius:8px; cursor:pointer;
    }
    .muted { color:#666; font-size:.95rem; }
  </style>
</head>
<body>
  <h2 id="title">üî¨ DSN Analysis</h2>
  <div id="status">‚è≥ Initializing‚Ä¶</div>
  <div id="timer" class="muted"></div>
  <a id="open-link" class="button" target="_blank" rel="noopener">üìÑ View Analysis Result</a><br/>
  <button id="exit-btn" type="button">üîô Exit</button>

  <script>
    // --- Config you might want to tweak ---
    const GH_PAGES_BASE = "https://soazcomms.github.io/";
    const STATUS_DIR    = "status"; // status/status-<label>.json
    const WEBHOOK_URL   = "https://sound-kangaroo-unlikely.ngrok-free.app/DSN_webhook";
    const POLL_INTERVAL_MS = 10000;   // 10s
    const TIMEOUT_MS       = 5 * 60 * 1000; // 5 minutes
    // --------------------------------------

    const qs = new URLSearchParams(location.search);
    const label = (qs.get("label") || "").slice(0, 8); // normalize "DSN###-S/T" to 8 chars
    const from  = qs.get("from");
    const to    = qs.get("to");

    const titleEl  = document.getElementById("title");
    const statusEl = document.getElementById("status");
    const timerEl  = document.getElementById("timer");
    const linkEl   = document.getElementById("open-link");
    const exitBtn  = document.getElementById("exit-btn");

    if (label) titleEl.innerHTML = `üî¨ DSN Analysis <b>${label}</b>`;
    if (!label || !from || !to) {
      statusEl.textContent = "‚ùå Missing required URL params: label, from, to.";
      console.error("Missing params:", { label, from, to });
      // Don‚Äôt proceed without required params
    } else {
      kickoff();
    }

    exitBtn.addEventListener("click", () => {
      // window.close() only works for script-opened tabs; fall back to history
      if (!window.close()) history.back();
    });

    async function kickoff() {
      // Fire the webhook (non-blocking for the UI)
      try {
        const res = await fetch(WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ label, from, to })
        });
        if (!res.ok) throw new Error(`Webhook HTTP ${res.status}`);
        statusEl.innerHTML = `üîÑ Running DSN analysis for <b>${label}</b><br/>‚è≥ Generating plots‚Ä¶`;
      } catch (e) {
        console.warn("Webhook trigger error:", e);
        statusEl.textContent = "‚è≥ Processing‚Ä¶ (webhook may be delayed)";
      }

      // Start polling for completion
      await pollForStatus();
    }

    function statusUrl() {
      // Cache busting with timestamp to avoid CDN stale cached JSON
      return `${GH_PAGES_BASE}${STATUS_DIR}/status-${label}.json?t=${Date.now()}`;
    }

    function resolveResultUrl(htmlField) {
      // Allow either absolute URL or a path like "analysis/DSN014-S/DSN014-S.analysis.html"
      if (/^https?:\/\//i.test(htmlField)) return htmlField;
      return GH_PAGES_BASE + htmlField.replace(/^\/+/, "");
    }

    const jobStart = Date.now(); // save when we triggered the job

    async function pollForStatus() {
      const start = Date.now();

      // helper to print debug in browser
      function debug(msg) {
        const dbg = document.createElement("div");
        dbg.style.fontSize = "0.9em";
        dbg.style.color = "#555";
        dbg.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        document.body.appendChild(dbg);
      } 

    while (Date.now() - start < TIMEOUT_MS) {
        const elapsedSec = Math.floor((Date.now() - start) / 1000);
	timerEl.textContent = `‚è±Ô∏è ${Math.floor((Date.now() - start) / 1000)}s elapsed`;
        debug(`Polling status.json for ${label} (elapsed ${elapsedSec}s)`);

	try {
          const res = await fetch(statusUrl(), { cache: "no-store" });
          debug(`HTTP ${res.status}`);
          if (res.ok) {
            const data = await res.json();
            debug(`JSON: ${JSON.stringify(data)}`);

            // Require JSON to have both fields AND be fresh
            if (
              data &&
              data.status &&
              data.html &&
              data.timestamp &&
              data.timestamp >= jobStart
            ) {
	      statusEl.innerHTML = data.status;
              linkEl.href = resolveResultUrl(data.html);
              linkEl.style.display = "inline-block";
              debug(`‚úÖ Found fresh status, showing link: ${data.html}`);
              return; // Done!
            } else {
              debug("‚ö†Ô∏è JSON exists but missing fields or timestamp too old");
            }
          } else {
            debug("‚ö†Ô∏è HTTP not OK");
          }

          statusEl.innerHTML = `‚è≥ Processing <b>${label}</b>‚Ä¶<br/><small>${new Date().toLocaleTimeString()}</small>`;
        } catch (e) {
          debug(`‚ùå Fetch failed: ${e}`);
          statusEl.innerHTML = `‚è≥ Waiting for processing to finish‚Ä¶<br/><small>${new Date().toLocaleTimeString()}</small>`;
        }
        await new Promise((r) => setTimeout(r, POLL_INTERVAL_MS));
      }
    }
</script>
</body>
</html>
