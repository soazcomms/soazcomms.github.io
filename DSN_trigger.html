<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>üî¨ DSN Analysis</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 2em; }
    #open-link { display:none; padding:0.6em 1.2em; font-size:1em; background:#007bff; color:#fff; border:none; border-radius:6px; text-decoration:none; }
    #exit-btn { margin-top:1.5em; padding:0.6em 1.2em; font-size:1em; background:#87CEFA; border:none; border-radius:6px; cursor:pointer; }
  </style>
</head>
<body>
  <h2 id="title">üî¨ DSN Analysis</h2>
  <div id="status">‚è≥ Waiting for processing to finish‚Ä¶</div>
  <div id="timer" style="margin:.5em 0;"></div>
  <a id="open-link" target="_blank">üìÑ View Analysis Result</a><br>
  <button id="exit-btn" onclick="window.close()">üîô Exit</button>

  <script>
    // Elements
    const titleEl   = document.getElementById('title');
    const statusDiv = document.getElementById('status');
    const timerEl   = document.getElementById('timer');
    const openLink  = document.getElementById('open-link');

    // Params
    const params = new URLSearchParams(window.location.search);
    const label  = (params.get('label') || '').slice(0, 8); // standardize 8 chars
    const from   = params.get('from');
    const to     = params.get('to');

    if (label) titleEl.innerHTML = `üî¨ DSN Analysis <b>${label}</b>`;
    if (!label || !from || !to) {
      statusDiv.textContent = '‚ùå Missing parameters in URL (label, from, to).';
      throw new Error('Missing required params');
    }

    // Trigger webhook (non-blocking)
    (async () => {
      try {
        const res = await fetch('https://sound-kangaroo-unlikely.ngrok-free.app/DSN_webhook', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ label, from, to })
        });
        if (!res.ok) throw new Error('Webhook trigger failed');
        statusDiv.innerHTML = `üîÑ Running DSN Analysis<br>‚è≥ Generating plots‚Ä¶`;
      } catch (e) {
        console.warn('Webhook error:', e);
        statusDiv.textContent = '‚è≥ Processing‚Ä¶ (webhook retry not implemented)';
      }
    })();

    // Poll for status (with cache-busting)
    const start = Date.now();
    const timeoutMs = 5 * 60 * 1000; // 5 minutes
    const statusURLBase = `https://soazcomms.github.io/status/status-${label}.json`;

    const poll = async () => {
      const elapsed = Math.floor((Date.now() - start) / 1000);
      timerEl.textContent = `‚è±Ô∏è ${elapsed}s elapsed`;

      try {
        const res = await fetch(`${statusURLBase}?t=${Date.now()}`, { cache: 'no-store' });
        if (res.ok) {
          const json = await res.json();
          // Expecting shape: { status: "‚úÖ ...", html: "https://..." OR "/analysis/...html" }
          if (json.status && json.html) {
            statusDiv.innerHTML = json.status;
            openLink.href = json.html.startsWith('http')
              ? json.html
              : `https://soazcomms.github.io/${json.html.replace(/^\/+/, '')}`;
            openLink.style.display = 'inline-block';
            return; // stop polling
          }
        }
        // Not ready yet
        statusDiv.innerHTML = `‚è≥ Still processing <b>${label}</b>‚Ä¶<br><small>${new Date().toLocaleTimeString()}</small>`;
      } catch (e) {
        statusDiv.innerHTML = `‚è≥ Waiting for processing to finish<br><small>${new Date().toLocaleTimeString()}</small>`;
      }

      if (Date.now() - start < timeoutMs) {
        setTimeout(poll, 10000); // try again in 10s
      } else {
        statusDiv.textContent = '‚ùå Timeout after waiting 5 minutes.';
      }
    };

    poll();
  </script>
</body>
</html>
