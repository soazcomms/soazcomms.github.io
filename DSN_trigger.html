<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-0PQTHF10EQ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-0PQTHF10EQ');
  </script>
  <meta charset="UTF-8" />
  <title>üî¨ DSN Analysis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root { --primary:#007bff; --accent:#87CEFA; --ok:#2e7d32; --warn:#c62828; --barbg:#edf2f7; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; text-align:center; margin:2rem; }
    h2 { margin-bottom:.25rem; }
    #status { margin:.5rem 0 .5rem; font-size:1.05rem; min-height:2.4em; }
    a.button {
      display:none; margin-top:.75rem; padding:.6rem 1.2rem; font-size:1rem;
      background:var(--primary); color:#fff; text-decoration:none; border-radius:8px;
    }
    .actions { margin-top:.75rem; display:flex; gap:.5rem; justify-content:center; flex-wrap:wrap; }
    button { padding:.55rem .95rem; font-size:.95rem; border:0; border-radius:8px; cursor:pointer; }
    #exit-btn { background:var(--accent); }
    #extend-btn { background:#e0e7ff; }
    .muted { color:#666; font-size:.9rem; }
    /* Progress bar (unchanged visuals) */
    .progress-wrap { width: min(720px, 90vw); margin: 1rem auto .25rem; text-align: center; }
    .progress { width: 50%; margin: 0 auto; height: 12px; background: var(--barbg); border-radius: 999px; overflow: hidden; box-shadow: inset 0 0 0 1px #e2e8f0; }
    .legend { width: 50%; margin: .35rem auto 0; display: flex; justify-content: space-between; font-size: .85rem; color: #555; }
    .bar { height:100%; width:0%; background: linear-gradient(90deg, #69c, #38bdf8 40%, #22c55e 75%, #16a34a 100%); transition: width .4s ease; }
    .bar.timeout { background: linear-gradient(90deg, #f59e0b, #ef4444); }
    .legend { display:flex; justify-content:space-between; font-size:.85rem; margin-top:.35rem; color:#555; }
  </style>
</head>
<body>
  <h2 id="title">üî¨ DSN Analysis</h2>
  <div id="status">‚è≥ Initializing‚Ä¶</div>

  <!-- Progress -->
  <div class="progress-wrap" aria-label="Progress toward timeout window">
    <div class="progress"><div id="bar" class="bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div></div>
    <div class="legend"><span id="leg-left" class="muted">0:00</span><span id="leg-right" class="muted">Timeout in 7:00</span></div>
  </div>

  <a id="open-link" class="button" target="_blank" rel="noopener">üìÑ View Analysis Result</a>

  <div class="actions">
    <button id="extend-btn" type="button" style="display:none;">‚è±Ô∏è Keep waiting 5 more min</button>
    <button id="exit-btn"   type="button">üîô Exit</button>
  </div>

<script>
  // === Config (kept from your current file) ===
  const GH_PAGES_BASE    = "https://soazcomms.github.io/";
  const STATUS_DIR       = "status";
  const WEBHOOK_URL      = "https://sound-kangaroo-unlikely.ngrok-free.app/DSN_webhook";
  const POLL_INTERVAL_MS = 10_000;
  const TIMEOUT_MS_INIT  = 7 * 60_000;   // initial window (unchanged)
  const EXTEND_MS        = 7 * 60_000;   // manual extend button (unchanged)

  // --- small debug/turd hook (present in your file; left intact) ---
  const WEBHOOK_ORIG = "https://sound-kangaroo-unlikely.ngrok-free.app";
  const TURD_URL     = WEBHOOK_ORIG + "/DSN_turd";
  const DEBUG_TURD   = true;                 // set false to disable client-side debug pings
  const RUN_ID       = "run-" + Date.now() + "-" + Math.random().toString(36).slice(2,8);
  function postJSON(url, obj) {
    return fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(obj||{}) });
  }
  function turd(step, note) {
    if (!DEBUG_TURD) return;
    postJSON(TURD_URL, { step, note: String(note||""), where:"HTML", label, from: fromISO, to: toISO, run_id: RUN_ID })
      .catch(()=>{});
  }

  // === Query & inputs ===
  const qs    = new URLSearchParams(location.search);
  const label = (qs.get("label")||"").trim();
  const from  = (qs.get("from") || "").trim();
  const to    = (qs.get("to")   || "").trim();

  // Harden incoming times to ISO; also compute short pretty spans
  function toISO(s) {
    if (!s) return "";
    try { return new Date(s).toISOString(); } catch { return ""; }
  }
  const fromISO = toISO(from);
  const toISO   = toISO(to);

  // DOM
  const titleEl = document.getElementById("title");
  const statusEl= document.getElementById("status");
  const linkEl  = document.getElementById("open-link");
  const barEl   = document.getElementById("bar");
  const legL    = document.getElementById("leg-left");
  const legR    = document.getElementById("leg-right");
  const extendBtn = document.getElementById("extend-btn");
  const exitBtn   = document.getElementById("exit-btn");

  // Title text
  if (label) titleEl.textContent = `üî¨ DSN Analysis ‚Äî ${label}`;

  // Progress state
  const jobStart   = Date.now();
  let timeoutMs    = TIMEOUT_MS_INIT;
  let extraTime    = 0;               // <-- unchanged behavior
  let lastStamp    = 0;
  let lastNote     = "";
  let lastStatus   = "";

  function mmss(ms) {
    const s = Math.max(0, Math.floor(ms/1000));
    const m = Math.floor(s/60);
    const r = s % 60;
    return `${m}:${String(r).padStart(2,"0")}`;
  }

  function updateProgress(timedOut) {
    const elapsed = Date.now() - jobStart;
    const total   = timeoutMs + extraTime;
    const pct     = Math.max(3, Math.min(100, Math.floor(elapsed / total * 100)));
    barEl.style.width = pct + "%";
    if (timedOut) barEl.classList.add("timeout"); else barEl.classList.remove("timeout");
    legL.textContent = mmss(elapsed);
    const remain = Math.max(0, total - elapsed);
    legR.textContent = timedOut ? "Waiting‚Ä¶" : `Timeout in ${mmss(remain)}`;
  }

  // unchanged: soft auto-extend on forward progress
  function softExtend(ms, why) {
    extraTime += ms;
    turd("auto_extend", `${why} +${Math.round(ms/60000)}m`);
  }

  // Manual extend button
  extendBtn.addEventListener("click", () => {
    extraTime += EXTEND_MS;
    extendBtn.style.display = "none";
    statusEl.innerHTML = "‚è≥ Extended‚Ä¶ still working.";
    turd("manual_extend", `+${Math.round(EXTEND_MS/60000)}m`);
  });

  // Exit button
  exitBtn.addEventListener("click", () => { window.close(); });

  // **Surgical addition**: prefer resolved full label for status polling
  let statusLabel = label;   // default to short label; updated after webhook returns JSON

  // Helpers
  function statusUrl() {
    const safe = (statusLabel || "").replace(/[^\w.\-]+/g, "_");  // CHANGED: use statusLabel
    return `${GH_PAGES_BASE}${STATUS_DIR}/status-${safe}.json?bust=${Date.now()}`;
  }
  function resolveResultUrl(relOrAbs) {
    return /^https?:\/\//i.test(relOrAbs) ? relOrAbs
      : `${GH_PAGES_BASE}${String(relOrAbs).replace(/^\/+/, "")}`;
  }

  // Kickoff ‚Üí webhook ‚Üí then poll
  (async function main(){
    statusEl.innerHTML = label
      ? `üîÑ Running DSN analysis for <b>${label}</b><br/>‚è≥ Generating plots‚Ä¶`
      : `üîÑ Running DSN analysis‚Ä¶<br/>‚è≥ Generating plots‚Ä¶`;

    try {
      const res = await fetch(WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ label, from: fromISO, to: toISO }) // hardened ISO
      });

      // **Surgical addition**: read JSON and adopt full_label if provided
      try {
        const j = await res.json().catch(() => null);
        if (j && j.full_label) {
          statusLabel = String(j.full_label).trim();
          turd("label-resolve", `${label} ‚Üí ${statusLabel}`);
        }
      } catch {}

      if (!res.ok) throw new Error(`Webhook HTTP ${res.status}`);
      turd("post_job_ok");
    } catch (e) {
      statusEl.textContent = "‚è≥ Processing‚Ä¶ (webhook may be delayed)";
      turd("post_job_fail", String(e));
    }

    // Poll loop (unchanged visuals/flow)
    while (true) {
      const elapsed = Date.now() - jobStart;
      const total   = timeoutMs + extraTime;
      const timedOut= elapsed >= total;
      updateProgress(timedOut);

      if (timedOut) {
        statusEl.innerHTML = "‚è±Ô∏è Still working‚Ä¶ might be a larger data window.<br/><span class='muted'>You can keep waiting.</span>";
        extendBtn.style.display = "inline-block";
        turd("timeout_window_hit");
      }

      try {
        const res = await fetch(statusUrl(), { cache: "no-store" });
        if (res.ok) {
          const data = await res.json();
          if ((data.timestamp||0) > lastStamp) {
            lastStamp = data.timestamp;
            softExtend(2 * 60_000, "status timestamp advanced");
          }
          if ((data.note||"") !== lastNote) {
            lastNote = data.note||"";
            softExtend(60_000, "note changed");
          }
          if ((data.status||"") !== lastStatus) {
            lastStatus = data.status||"";
            softExtend(60_000, "status changed");
          }

          if (data && data.status && data.html && (data.timestamp||0) >= jobStart) {
            statusEl.innerHTML = data.status;
            linkEl.href = resolveResultUrl(data.html);
            linkEl.style.display = "inline-block";
            barEl.style.width = "100%";
            barEl.classList.remove("timeout");
            legR.textContent = "Complete";
            turd("html_ready", data.html);
            break;
          }
        } else {
          turd("status_http", "HTTP "+res.status);
        }

        if (!timedOut) statusEl.innerHTML = `‚è≥ Generating plots‚Ä¶`;
      } catch (e) {
        if (!timedOut) statusEl.innerHTML = `‚è≥ Waiting for processing‚Ä¶`;
        turd("status_fetch_fail", String(e));
      }

      await new Promise(r => setTimeout(r, POLL_INTERVAL_MS));
    }
  })();
</script>
</body>
</html>
