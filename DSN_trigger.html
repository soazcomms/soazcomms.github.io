<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>DSN Analysis Trigger</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 2em;
    }
    #status {
      font-size: 1.2em;
      margin-bottom: 1em;
    }
    #open-link {
      display: none;
      font-size: 1em;
      padding: 0.6em 1.2em;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #exit-btn {
	font-size: 1em;
	padding: 0.6em 1.2em;
	background-color: #87CEFA;  /* Light blue */
	color: black;
	border: none;
	border-radius: 5px;
	cursor: pointer;
    }
  </style>
  
</head>
<body>
  <h1 id="title">ğŸ”¬ DSN Analysis</h1>
  <div id="status">â³ Calculating...</div>
  <a id="open-link" href="#" target="_blank">ğŸ“„ View Analysis Result</a><br><br>
  <button id="exit-btn" onclick="window.close()">ğŸ”™ Exit</button>
  <script>
    const statusDiv = document.getElementById("status");
    const openLink = document.getElementById("open-link");

    const urlParams = new URLSearchParams(window.location.search);
    const label = urlParams.get("label");
    const from = urlParams.get("from");
    const to = urlParams.get("to");
    if (label) {
	document.getElementById("title").innerHTML = `ğŸ”¬ DSN Analysis <b>${label}</b>`;
    }
    if (!label || !from || !to) {
      statusDiv.textContent = "âŒ Missing parameters in URL.";
    } else {
      // Trigger webhook
      const webhookURL = "https://sound-kangaroo-unlikely.ngrok-free.app/DSN_webhook";
      fetch(webhookURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ label, from, to })
      }).then(res => {
        if (!res.ok) throw new Error("Webhook trigger failed");
        statusDiv.innerHTML = `ğŸ”„ Running DSN Analysis<br>â³ Generating plots...`;
      }).catch(err => {
        console.error("âŒ Webhook trigger error:", err);
        statusDiv.textContent = "â³ Processing...";
      });

      // Poll for status
      async function checkStatus() {
        const statusURL = `https://soazcomms.github.io/status/status-${label}.json`;
	console.log("ğŸ” Checking status at:", statusURL);

	try {
          const response = await fetch(statusURL);
	  console.log("ğŸ“¡ Response status:", response.status);

	  if (!response.ok) throw new Error("Not ready");

	  const result = await response.json();
	  console.log("ğŸ“„ Fetched JSON:", result);

	  if (result.status && result.html) {
            statusDiv.innerHTML = `âœ… Analysis for <b>${label}</b> is complete!`;
            openLink.href = result.html;
            openLink.style.display = "inline-block";
	  } else {
            throw new Error("Missing fields in JSON");
	  }
	} catch (err) {
	  console.warn("â³ Retry in 10 sec:", err.message);
	  setTimeout(checkStatus, 10000);
	}
       }

      checkStatus();

</script>
</body>
</html>
