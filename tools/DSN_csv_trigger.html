<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<title>DSN CSV Export</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:20px;line-height:1.45}
  .wrap{max-width:780px}
  h1{margin:0 0 .5rem 0}
  .muted{color:#666}
  .row{margin:1rem 0}
  .btn{display:inline-block;padding:.6rem 1rem;border:1px solid #ddd;border-radius:8px;text-decoration:none;cursor:pointer}
  .btn[disabled]{opacity:.5;pointer-events:none}
  .ok{color:#0a6}
  .err{color:#b00}
  /* high-visibility red progress bar that flips to green at done */
  .bar{height:14px;background:#222;border-radius:7px;overflow:hidden;outline:2px solid #900}
  .bar>span{display:block;height:100%;width:0%;background:#ff1744;box-shadow:0 0 6px #ff1744,0 0 12px #ff1744;transition:width .45s ease}
  .wrap.done .bar>span{background:#18c37e;box-shadow:0 0 6px #18c37e,0 0 12px #18c37e}
  .hint{font-size:.9rem;color:#666}
</style>

<div class="wrap" id="wrap">
  <h1>DSN CSV Export</h1>
  <div class="muted" id="desc">Preparing‚Ä¶</div>

  <div class="row">
    <div class="bar"><span id="bar"></span></div>
  </div>

  <div class="row">
    <a id="download" class="btn" aria-disabled="true">‚¨á Download CSV</a>
    <a id="viewlog" class="btn" target="_blank" rel="noopener" style="display:none;">ü™µ View log</a>
    <a id="retry"   class="btn" href="#" style="display:none;">‚Üª Retry</a>
  </div>

  <div class="row muted" id="status">Waiting for job to start‚Ä¶</div>
  <div class="row hint" id="hint" style="display:none;"></div>
</div>

<script>
(function(){
  const GH_PAGES_BASE = "https://soazcomms.github.io";
  const GH_RAW_BASE   = "https://raw.githubusercontent.com/soazcomms/soazcomms.github.io/main";
  const WEBHOOK_URL   = "https://sound-kangaroo-unlikely.ngrok-free.app/DSN_csv";

  const qs      = new URLSearchParams(location.search);
  const label   = (qs.get("label")||"").trim();
  const from    = (qs.get("from") || "").trim();
  const to      = (qs.get("to")   || "").trim();

  const wrapEl  = document.getElementById("wrap");
  const statusEl= document.getElementById("status");
  const barEl   = document.getElementById("bar");
  const dlEl    = document.getElementById("download");
  const logEl   = document.getElementById("viewlog");
  const retryEl = document.getElementById("retry");
  const descEl  = document.getElementById("desc");
  const hintEl  = document.getElementById("hint");

  const toYMD = s => String(s).slice(0,10).replaceAll("/","-");
  const yFrom = toYMD(from), yTo = toYMD(to);
  const safeLabel = (label || "").replace(/[^\w.\-]+/g, "_");

  descEl.textContent = `Label: ${label} ¬∑ Range: ${yFrom} ‚Üí ${yTo}`;

  // show disabled Download button immediately (UX requirement)
  dlEl.setAttribute("disabled","true");
  dlEl.classList.add("disabled");
  dlEl.href = "#";

  // trigger CSV job
  fetch(WEBHOOK_URL, {
    method: "POST",
    headers: { "content-type": "application/json" },
    body: JSON.stringify({ label, from: yFrom, to: yTo })
  }).then(()=>{ statusEl.textContent = "Triggered‚Ä¶ generating CSV"; })
    .catch(()=>{ statusEl.textContent = "Triggered (no response)"; });

  // progress scaffolding
  let pct = 6, lastTs = 0, ticks = 0;
  const bump = () => { pct = Math.min(95, pct + 1 + Math.min(6, Math.floor(ticks/5))); barEl.style.width = pct + "%"; ticks++; };
  const tickTimer = setInterval(bump, 900);

  // status file (prefer RAW to dodge CDN cache; fallback to Pages)
  const statusRel = `status/status-${safeLabel}.json`;
  const rawURL    = `${GH_RAW_BASE}/${statusRel}`;
  const pagesURL  = `${GH_PAGES_BASE}/${statusRel}`;

  async function getStatus() {
    const bust = `bust=${Date.now()}`;
    // try RAW first
    try {
      const r = await fetch(`${rawURL}?${bust}`, {cache:"no-store"});
      if (r.ok) return await r.json();
    } catch (_e) {}
    // then Pages
    try {
      const r = await fetch(`${pagesURL}?${bust}`, {cache:"no-store"});
      if (r.ok) return await r.json();
    } catch (_e) {}
    return null;
  }

  function armDownload(csvPath) {
    const abs = /^https?:\/\//i.test(csvPath)
      ? csvPath
      : `${GH_PAGES_BASE}/${csvPath.replace(/^\/+/, "")}`;
    const bust = `${abs}${abs.includes("?") ? "&" : "?"}bust=${Date.now()}`;
    const pretty = `${label}_${yFrom}_${yTo}.csv`;
    dlEl.href = bust;
    dlEl.download = pretty;
    dlEl.removeAttribute("disabled");
    dlEl.classList.remove("disabled");
  }

  const pollTimer = setInterval(async () => {
    const data = await getStatus();
if (data) data.note = "";    if (!data) return;

    // live log link if present
    if (data.log) {
      const logAbs = /^https?:\/\//i.test(data.log) ? data.log
                    : `${GH_PAGES_BASE}/${String(data.log).replace(/^\/+/, "")}`;
      logEl.href = `${logAbs}${logAbs.includes("?") ? "&" : "?"}bust=${Date.now()}`;
      logEl.style.display = "inline-block";
    }

    // if timestamp advanced, nudge bar
    if (data.timestamp && data.timestamp !== lastTs) {
      lastTs = data.timestamp;
      pct = Math.min(97, pct + 2);
      barEl.style.width = pct + "%";
    }

    const phase = String(data.phase||"").toLowerCase();

    if (phase === "done") {
      clearInterval(pollTimer); clearInterval(tickTimer);
      barEl.style.width = "100%";
      wrapEl.classList.add("done");
      statusEl.innerHTML = '<span class="ok">‚úÖ CSV ready.</span>';

      if (data.csv) armDownload(String(data.csv));
      hintEl.style.display = "block";
      hintEl.textContent = "Tip: if the browser blocks the first attempt, click Download again. File will be removed server-side later.";
      return;
    }

    if (phase === "error") {
      clearInterval(pollTimer); clearInterval(tickTimer);
      barEl.style.width = "100%";
      const note = data.note ? ` <small>${data.note}</small>` : "";
      statusEl.innerHTML = `<span class="err">‚ùå Failed.</span>${note}`;
      retryEl.style.display = "inline-block";
      return;
    }

    // running or unknown -> show concise working line
    const note = (data.note && String(data.note).trim()) ? ` ‚Äî ${data.note}` : "";
    statusEl.textContent = `‚öôÔ∏è Working‚Ä¶${note}`;
  }, 1000);

  retryEl.onclick = (e)=>{ e.preventDefault(); location.reload(); };
})();
</script>
