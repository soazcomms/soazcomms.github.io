<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<title>DSN CSV Export</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:2rem;line-height:1.45}
  .wrap{max-width:780px}
  h1{margin:0 0 .5rem 0}
  .muted{color:#666}
  .row{margin:1rem 0}
  .btn{display:inline-block;padding:.6rem 1rem;border:1px solid #ddd;border-radius:8px;text-decoration:none;cursor:pointer;user-select:none}
  .btn[aria-disabled="true"]{opacity:.5;pointer-events:none}
  .ok{color:#0a6}
  .err{color:#b00}
  /* Determinate bar: we set width via JS ticks (no shimmer) */
  .bar{height:8px;background:#eee;border-radius:6px;overflow:hidden}
  .bar>span{display:block;height:100%;width:0%;background:#cfeadf;transition:width .45s ease}
  .hint{font-size:.9rem;color:#666}
</style>

<div class="wrap" id="wrap">
  <h1>DSN CSV Export</h1>
  <div class="muted" id="desc">Preparing‚Ä¶</div>

  <div class="row"><div class="bar"><span id="bar"></span></div></div>

  <div class="row">
    <a id="download" class="btn" href="#" aria-disabled="true" rel="noopener">‚¨á Download CSV</a>
    <a id="viewlog" class="btn" target="_blank" rel="noopener" style="display:none;">ü™µ View log</a>
    <a id="retry" class="btn" href="#" style="display:none;">‚Üª Retry</a>
  </div>

  <div class="row muted" id="status">Waiting for job to start‚Ä¶</div>
  <div class="row hint" id="hint" style="display:none;"></div>
</div>

<script>
/* --- CONFIG --- */
const GH_PAGES_BASE = "https://soazcomms.github.io/";
const WEBHOOK_BASE  = "https://sound-kangaroo-unlikely.ngrok-free.app";
const API_START     = WEBHOOK_BASE + "/DSN_csv";
const API_CLEANUP   = WEBHOOK_BASE + "/DSN_cleanup";
const POLL_MS       = 1000;            // status.json poll cadence
const TICK_MS       = 600;             // progress bar tick cadence
const STALL_SECS    = 90;              // if timestamp doesn't move this long, show stalled
const MAX_FILL      = 93;              // fill to 93% while running; jump to 100% on done/error

(function(){
  const qs = new URLSearchParams(location.search);
  const label = (qs.get("label")||"").trim();
  const from  = (qs.get("from") || "").trim().split("?")[0];
  const to    = (qs.get("to")   || "").trim().split("?")[0];

  const wrap    = document.getElementById("wrap");
  const descEl  = document.getElementById("desc");
  const barEl   = document.getElementById("bar");
  const statusEl= document.getElementById("status");
  const dlEl    = document.getElementById("download");
  const logEl   = document.getElementById("viewlog");
  const retryEl = document.getElementById("retry");
  const hintEl  = document.getElementById("hint");

  descEl.textContent = `Label: ${label} ¬∑ Range: ${from} ‚Üí ${to}`;

  const toYMD = s => String(s).slice(0,10).replaceAll("/","-");
  const yFrom = toYMD(from), yTo = toYMD(to);
  const safeLabel = (label || "").replace(/[^\w.\-]+/g, "_");
  const statusURL = `${GH_PAGES_BASE}status/status-${safeLabel}.json`;

  // Show Download button immediately (disabled until ready)
  dlEl.style.display = "inline-block";
  dlEl.setAttribute("aria-disabled","true");

  // Start the job (fire-and-forget)
  fetch(API_START, {
    method: "POST",
    headers: { "content-type": "application/json" },
    body: JSON.stringify({ label, from: yFrom, to: yTo })
  }).then(() => {
    statusEl.textContent = "Triggered‚Ä¶ generating CSV";
  }).catch(() => {
    statusEl.textContent = "Triggered (no response yet)";
  });

  // Determinate progress: smoothly fill to MAX_FILL while running
  let pct = 3;
  barEl.style.width = pct + "%";
  const tickTimer = setInterval(() => {
    pct = Math.min(MAX_FILL, pct + 2);
    barEl.style.width = pct + "%";
  }, TICK_MS);

  // Poll status.json
  let pollTimer = null;
  let lastTs = 0;
  let lastTsSeenAt = Date.now();

  async function poll() {
    try {
      const resp = await fetch(`${statusURL}?bust=${Date.now()}`, { cache: "no-store" });
      if (!resp.ok) return; // keep polling silently
      const data = await resp.json();

      // Attach log link ASAP
      if (data.log) {
        const logAbs = /^https?:\/\//i.test(data.log) ? data.log
                    : GH_PAGES_BASE + String(data.log).replace(/^\/+/, "");
        logEl.href = `${logAbs}${logAbs.includes("?") ? "&" : "?"}bust=${Date.now()}`;
        logEl.style.display = "inline-block";
      }

      // Track timestamp to detect stalls
      if (typeof data.timestamp === "number") {
        if (data.timestamp !== lastTs) {
          lastTs = data.timestamp;
          lastTsSeenAt = Date.now();
        }
      }

      const phase = String(data.phase||"").toLowerCase();
      if (phase === "done") {
        // Success
        clearInterval(pollTimer); clearInterval(tickTimer);
        barEl.style.width = "100%";
        statusEl.innerHTML = '<span class="ok">‚úÖ CSV ready.</span>';

        // Prefer csv_raw if present; otherwise use csv (Pages)
        const finalUrl = data.csv_raw || data.csv || "";
        const absolute = /^https?:\/\//i.test(finalUrl)
          ? finalUrl
          : (finalUrl ? GH_PAGES_BASE.replace(/\/+$/,"") + "/" + String(finalUrl).replace(/^\/+/, "") : "");

        if (!absolute) {
          statusEl.innerHTML = '<span class="err">‚ùå Ready, but no download URL reported.</span>';
          retryEl.style.display = "inline-block";
          retryEl.onclick = e => { e.preventDefault(); location.reload(); };
          return;
        }

        const pretty = `${label}_${yFrom}_${yTo}.csv`;
        const bust   = `${absolute}${absolute.includes("?") ? "&" : "?"}bust=${Date.now()}`;

        dlEl.href = bust;
        dlEl.download = pretty;
        dlEl.removeAttribute("aria-disabled");

        // Cleanup AFTER user clicks download (fire-and-forget, slight delay)
        dlEl.onclick = async (e) => {
          if (dlEl.getAttribute("aria-disabled") === "true") { e.preventDefault(); return; }
          setTimeout(async () => {
            try {
              await fetch(API_CLEANUP, {
                method: "POST",
                headers: { "content-type": "application/json" },
                body: JSON.stringify({ label, from: yFrom, to: yTo })
              });
            } catch {}
          }, 7000);
        };

        hintEl.style.display = "block";
        hintEl.textContent = "If your browser blocks the first attempt, click Download again.";

        return;
      }

      if (phase === "error") {
        // Error path
        clearInterval(pollTimer); clearInterval(tickTimer);
        barEl.style.width = "100%";
        statusEl.innerHTML = `<span class="err">‚ùå Failed.</span>`;
        retryEl.style.display = "inline-block";
        retryEl.onclick = e => { e.preventDefault(); location.reload(); };
        return;
      }

      // Running (ignore backend 'note' to avoid confusing users)
      statusEl.textContent = "‚öôÔ∏è Working‚Ä¶";

      // Stall detector
      const stalledFor = (Date.now() - lastTsSeenAt) / 1000;
      if (stalledFor >= STALL_SECS) {
        statusEl.innerHTML = `<span class="err">‚ö†Ô∏è No progress in ${Math.round(stalledFor)}s.</span>`;
        retryEl.style.display = "inline-block";
        retryEl.onclick = e => { e.preventDefault(); location.reload(); };
        clearInterval(pollTimer); clearInterval(tickTimer);
        barEl.style.width = "100%";
        return;
      }

    } catch (e) {
      // Silent; keep polling
    }
  }

  pollTimer = setInterval(poll, POLL_MS);
  // Kick one immediate poll so UI updates quickly
  poll();

})();
</script>
</html>

<!-- STAMP: DSN_csv_trigger 20251029173256 -->
<div id="stamp" style="position:fixed;right:8px;bottom:8px;font:12px/1.2 monospace;color:#999;">STAMP 20251029173256</div>
