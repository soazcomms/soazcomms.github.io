<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<title>DSN CSV Export</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:20px;line-height:1.45}
  .wrap{max-width:780px}
  h1{margin:0 0 .5rem 0}
  .muted{color:#666}
  .row{margin:1rem 0}
  .btn{display:inline-block;padding:.6rem 1rem;border:1px solid #ddd;border-radius:8px;text-decoration:none;cursor:pointer}
  .btn.disabled{opacity:.5;pointer-events:none}
  .ok{color:#0a6}
  .err{color:#b00}
  .bar{height:14px;background:#222;border-radius:7px;overflow:hidden;outline:2px solid #900}
  .bar>span{display:block;height:100%;width:0%;
            background:#ff1744;box-shadow:0 0 6px #ff1744,0 0 12px #ff1744;transition:width .25s ease}
  .done .bar>span{background:#18c37e;box-shadow:0 0 6px #18c37e,0 0 12px #18c37e}
  .hint{font-size:.9rem;color:#666}
</style>

<div class="wrap" id="wrap">
  <h1>DSN CSV Export</h1>
  <div class="muted" id="desc">Preparing‚Ä¶</div>

  <div class="row"><div class="bar"><span id="bar"></span></div></div>

  <div class="row">
    <a id="download" class="btn disabled" href="#">‚¨á Download CSV</a>
    <a id="viewlog" class="btn disabled" target="_blank" rel="noopener" href="#">ü™µ View log</a>
    <a id="retry"   class="btn" href="#" style="display:none;">‚Üª Retry</a>
  </div>

  <div class="row muted" id="status">‚öôÔ∏è Working‚Ä¶</div>
  <div class="row hint"   id="hint" style="display:none;"></div>
</div>

<script>
(() => {
  // ===== endpoints =====
  const GH_PAGES_BASE = "https://soazcomms.github.io";
  const GH_RAW_BASE   = "https://raw.githubusercontent.com/soazcomms/soazcomms.github.io/main";
  const WEBHOOK_ORIG  = "https://sound-kangaroo-unlikely.ngrok-free.app";
  const WEBHOOK_URL   = WEBHOOK_ORIG + "/DSN_csv";
  const CLEANUP_URL   = WEBHOOK_ORIG + "/DSN_cleanup";
  const TURD_URL      = WEBHOOK_ORIG + "/DSN_turd";

  // ===== query =====
  const qs      = new URLSearchParams(location.search);
  const label   = (qs.get("label")||"").trim();
  const fromQ   = (qs.get("from") || "").trim();
  const toQ     = (qs.get("to")   || "").trim();

  // ===== dom =====
  const wrapEl  = document.getElementById("wrap");
  const statusEl= document.getElementById("status");
  const barFill = document.getElementById("bar");
  const dlEl    = document.getElementById("download");
  const logEl   = document.getElementById("viewlog");
  const retryEl = document.getElementById("retry");
  const descEl  = document.getElementById("desc");
  const hintEl  = document.getElementById("hint");

  // ===== helpers =====
  const toYMD = s => String(s).slice(0,10).replaceAll("/","-");
  const yFrom = toYMD(fromQ), yTo = toYMD(toQ);
  const yFromC = yFrom.replaceAll("-","");
  const yToC   = yTo.replaceAll("-","");
  const safeLabel = (label||"").replace(/[^\w.\-]+/g, "_");
  descEl.textContent = `Label: ${label} ¬∑ Range: ${yFrom} ‚Üí ${yTo}`;

  const bust = u => u + (u.includes("?") ? "&" : "?") + "bust=" + Date.now();
  const setDisabled = (a, dis=true) => { if (dis) { a.classList.add("disabled"); a.setAttribute("aria-disabled","true"); } else { a.classList.remove("disabled"); a.removeAttribute("aria-disabled"); } };
  const HEAD = async (u)=>{ try{ const r=await fetch(bust(u),{method:"HEAD",cache:"no-store",redirect:"follow"}); return r && r.ok; }catch{ return false; } };
  const GETBLOB = async (u)=>{ const r=await fetch(bust(u),{method:"GET",cache:"no-store",redirect:"follow"}); if(!r.ok) throw new Error("HTTP "+r.status); return await r.blob(); };
  const turd = async (step, note="")=>{
    try {
      const payload = JSON.stringify({ step, label, from:yFrom, to:yTo, note });
      const b = new Blob([payload], { type: "application/json" });
      if (!(navigator.sendBeacon && navigator.sendBeacon(TURD_URL, b))) {
        await fetch(TURD_URL, { method:"POST", headers:{"content-type":"application/json"}, body: payload });
      }
    } catch {}
  };

  // expected names (status.json not required)
  const csvRel = `DSNdata/${safeLabel}_${yFromC}_${yToC}.csv`;
  const logRel = `logs/csv-${safeLabel}-${yFromC}-${yToC}.log`;
  const csvRAW = `${GH_RAW_BASE}/${csvRel}`;
  const csvPGS = `${GH_PAGES_BASE}/${csvRel}`;
  const logRAW = `${GH_RAW_BASE}/${logRel}`;
  const logPGS = `${GH_PAGES_BASE}/${logRel}`;

  // ===== progress ‚Äî faster monotonic fill (‚â§ 45s cap) =====
  let done=false, start=Date.now();
  barFill.style.width = "20%"; // jumpstart
  const tick = setInterval(()=>{
    if (done) return;
    const elapsed = Date.now()-start;
    const capMs = 45000; // faster than before
    const pct = Math.min(97, 20 + (elapsed/capMs)*77);
    barFill.style.width = pct.toFixed(1) + "%";
  }, 200);

  turd("page_load", "HTML loaded");

  // ===== start server job (idempotent) =====
  (async ()=>{
    try {
      await turd("post_job", "POST /DSN_csv");
      await fetch(WEBHOOK_URL, {
        method:"POST",
        headers:{"content-type":"application/json"},
        body: JSON.stringify({ label, from: yFrom, to: yTo })
      });
      await turd("post_job_ok");
    } catch (e) {
      await turd("post_job_fail", String(e));
    }
  })();

  // ===== enable log as soon as it exists =====
  async function tryEnableLog(){
    if (await HEAD(logRAW)) { logEl.href = bust(logRAW); setDisabled(logEl,false); await turd("log_head_ok","raw"); return; }
    if (await HEAD(logPGS)) { logEl.href = bust(logPGS); setDisabled(logEl,false); await turd("log_head_ok","pages"); return; }
  }
  logEl.href = bust(logRAW);

  // ===== download handler =====
  function armDownload(urls){
    setDisabled(dlEl,false);
    dlEl.onclick = async (e)=>{
      e.preventDefault();
      statusEl.textContent = "Preparing download‚Ä¶";
      const pretty = `${safeLabel}_${yFrom}_${yTo}.csv`;
      await turd("download_click", "start");

      for (const u of urls){
        try{
          await turd("download_try", u);
          const blob = await GETBLOB(u);
          const obj = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = obj; a.download = pretty;
          document.body.appendChild(a); a.click(); a.remove();
          setTimeout(()=> URL.revokeObjectURL(obj), 1500);

          // cleanup after download begins
          try {
            await turd("cleanup_request", csvRel);
            const payload = JSON.stringify({ csv: csvRel });
            const b = new Blob([payload], { type: "application/json" });
            if (!(navigator.sendBeacon && navigator.sendBeacon(CLEANUP_URL, b))) {
              await fetch(CLEANUP_URL, {
                method:"POST", headers:{"content-type":"application/json"}, body: payload
              });
            }
            await turd("cleanup_sent");
          } catch {}

          // finish
          done=true; clearInterval(tick); barFill.style.width="100%"; wrapEl.classList.add("done");
          statusEl.innerHTML = '<span class="ok">‚úÖ CSV downloaded.</span>';
          hintEl.style.display="block"; hintEl.textContent = "If your browser blocks the first attempt, click Download again.";
          await turd("download_done");
          return;
        }catch(err){
          await turd("download_try_fail", String(err));
        }
      }
      statusEl.innerHTML = `‚ö†Ô∏è Download failed: HTTP 404`;
      await turd("download_fail_final");
    };
  }

  // ===== poll for CSV + LOG directly (RAW first) =====
  const MAX_MS = 45000;  // 45s fast cap
  const CAD    = 700;

  const poll = setInterval(async ()=>{
    if (done) return;

    tryEnableLog();

    // CSV appears?
    if (await HEAD(csvRAW)) {
      await turd("csv_head_ok","raw");
      clearInterval(poll);
      done=true; clearInterval(tick); barFill.style.width="100%"; wrapEl.classList.add("done");
      statusEl.innerHTML = '<span class="ok">‚úÖ CSV ready.</span>';
      armDownload([csvRAW, csvPGS]);
      return;
    }
    if (await HEAD(csvPGS)) {
      await turd("csv_head_ok","pages");
      clearInterval(poll);
      done=true; clearInterval(tick); barFill.style.width="100%"; wrapEl.classList.add("done");
      statusEl.innerHTML = '<span class="ok">‚úÖ CSV ready.</span>';
      armDownload([csvRAW, csvPGS]);
      return;
    }

    if ((Date.now()-start) > MAX_MS) {
      clearInterval(poll); clearInterval(tick);
      barFill.style.width="100%";
      statusEl.innerHTML = `<span class="err">‚ùå File not found where expected.</span>`;
      retryEl.style.display="inline-block";
      retryEl.onclick = async (e)=>{ e.preventDefault(); await turd("retry_click"); location.reload(); };
      await turd("timeout_no_csv");
    }
  }, CAD);
})();
</script>
</html>

<!-- STAMP: DSN_csv_trigger 20251030181337 -->
<div id="stamp" style="position:fixed;right:8px;bottom:8px;font:12px/1.2 monospace;color:#999;">STAMP 20251030181337</div>
