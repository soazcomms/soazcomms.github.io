<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<title>DSN CSV Export</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:2rem;line-height:1.45}
  .wrap{max-width:780px}
  h1{margin:0 0 .5rem 0}
  .muted{color:#666}
  .row{margin:1rem 0}
  .btn{display:inline-block;padding:.6rem 1rem;border:1px solid #ddd;border-radius:8px;text-decoration:none;cursor:pointer}
  .btn[disabled]{opacity:.5;pointer-events:none}
  .ok{color:#0a6}
  .err{color:#b00}
  .bar{height:8px;background:#eee;border-radius:6px;overflow:hidden}
  .bar>span{display:block;height:100%;width:0%;transition:width .6s}
  .hint{font-size:.9rem;color:#666}
</style>

<div class="wrap">
  <h1>DSN CSV Export</h1>
  <div class="muted" id="desc">Preparing‚Ä¶</div>

  <div class="row"><div class="bar"><span id="bar"></span></div></div>

  <div class="row">
    <!-- Download is visible from the start but disabled until the file is reachable -->
    <a id="download" class="btn" href="#" disabled>‚¨á Download CSV</a>
    <a id="viewlog" class="btn" target="_blank" rel="noopener" style="display:none;">ü™µ View log</a>
    <a id="retry" class="btn" href="#" style="display:none;">‚Üª Retry</a>
  </div>

  <div class="row muted" id="status">Waiting for job to start‚Ä¶</div>
  <div class="row hint" id="hint" style="display:none;"></div>
</div>

<script>
const GH_PAGES_BASE = "https://soazcomms.github.io/";
const WEBHOOK_URL   = "https://sound-kangaroo-unlikely.ngrok-free.app/DSN_csv";

/* -------- helpers -------- */

const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

async function headOk(url) {
  try {
    const resp = await fetch(url, { method: "HEAD", cache: "no-store" });
    return resp.ok;
  } catch { return false; }
}

// Try URLs in order; return the first that responds 200 to HEAD (with retries)
async function firstReachable(urls, {tries=20, delay=700}={}) {
  for (let i=0; i<tries; i++) {
    for (const u of urls) {
      if (await headOk(u)) return u;
    }
    await sleep(delay);
  }
  return null;
}

// bump ‚Äúprogress bar‚Äù gently until complete
function startBar(barEl) {
  let pct = 8;
  barEl.style.width = pct + "%";
  const tick = setInterval(()=>{
    pct = Math.min(95, pct + 2);
    barEl.style.width = pct + "%";
  }, 1200);
  return ()=>clearInterval(tick);
}

/* -------- main -------- */

(function(){
  const qs      = new URLSearchParams(location.search);
  const label   = (qs.get("label")||"").trim();
  const from    = (qs.get("from") || "").trim();
  const to      = (qs.get("to")   || "").trim();

  const statusEl= document.getElementById("status");
  const barEl   = document.getElementById("bar");
  const dlEl    = document.getElementById("download");
  const logEl   = document.getElementById("viewlog");
  const retryEl = document.getElementById("retry");
  const descEl  = document.getElementById("desc");
  const hintEl  = document.getElementById("hint");

  descEl.textContent = `Label: ${label} ¬∑ Range: ${from} ‚Üí ${to}`;

  const toYMD = s => String(s).slice(0,10).replaceAll("/","-");
  const yFrom = toYMD(from), yTo = toYMD(to);

  // kick job
  fetch(WEBHOOK_URL, {
    method: "POST",
    headers: { "content-type": "application/json" },
    body: JSON.stringify({ label, from: yFrom, to: yTo })
  }).then(() => {
    statusEl.textContent = "Triggered‚Ä¶ generating CSV";
  }).catch(() => {
    statusEl.textContent = "Triggered (no response)";
  });

  // show disabled download from the start (requested behavior)
  dlEl.textContent = "‚¨á Download CSV";
  dlEl.setAttribute("disabled", "true");
  dlEl.style.display = "inline-block";

  const stopBar = startBar(barEl);

  const safeLabel = (label || "").replace(/[^\w.\-]+/g, "_");
  const statusRel = `status/status-${safeLabel}.json`;
  const statusURL = GH_PAGES_BASE + statusRel;

  const poll = setInterval(async () => {
    let data;
    try {
      const resp = await fetch(`${statusURL}?bust=${Date.now()}`, { cache: "no-store" });
      if (!resp.ok) return;
      data = await resp.json();
    } catch (_e) { return; }

    // show log link asap
    if (data.log) {
      const logAbs = /^https?:\/\//i.test(data.log)
        ? data.log
        : GH_PAGES_BASE + String(data.log).replace(/^\/+/, "");
      logEl.href = `${logAbs}${logAbs.includes("?") ? "&" : "?"}bust=${Date.now()}`;
      logEl.style.display = "inline-block";
    }

    const phase = (data.phase || "").toLowerCase();

    if (phase === "error") {
      clearInterval(poll); stopBar();
      barEl.style.width = "100%";
      const note = data.note ? ` <small>${data.note}</small>` : "";
      statusEl.innerHTML = `<span class="err">‚ùå Failed.</span>${note}`;
      retryEl.style.display = "inline-block";
      retryEl.onclick = (e)=>{ e.preventDefault(); location.reload(); };
      return;
    }

    // keep showing ‚Äúnote‚Äù (heartbeat) while running
    if (phase !== "done") {
      if (data.note && String(data.note).trim().length > 0) {
        statusEl.textContent = `‚öôÔ∏è ${data.note}`;
      } else {
        statusEl.textContent = "‚öôÔ∏è Working‚Ä¶";
      }
      return;
    }

    // DONE ‚Üí resolve a reachable download URL
    clearInterval(poll); stopBar();
    barEl.style.width = "100%";
    statusEl.innerHTML = '<span class="ok">‚úÖ CSV ready.</span>';

    const rel = data.csv || "";
    const pagesAbs = rel
      ? (/^https?:\/\//i.test(rel) ? rel
         : GH_PAGES_BASE.replace(/\/+$/, "") + "/" + String(rel).replace(/^\/+/, ""))
      : "";

    // prefer Pages URL, but fall back to raw if Pages not propagated yet
    const candidates = [];
    if (pagesAbs) candidates.push(pagesAbs);
    if (data.csv_raw) candidates.push(data.csv_raw);

    // add a cache-buster to each candidate
    const withBust = candidates.map(u => u + (u.includes("?") ? "&" : "?") + "bust=" + Date.now());

    const reachable = await firstReachable(withBust, {tries: 40, delay: 500}); // ~20s worst case
    if (!reachable) {
      statusEl.innerHTML = `<span class="err">‚ùå CSV published but not yet visible on CDN.</span>
        <small class="muted">The file is in git, but GitHub Pages/RAW endpoints haven‚Äôt propagated. Try Retry.</small>`;
      retryEl.style.display = "inline-block";
      retryEl.onclick = (e)=>{ e.preventDefault(); location.reload(); };
      return;
    }

    // enable button and auto-click once
    const pretty = `${label}_${yFrom}_${yTo}.csv`;
    dlEl.removeAttribute("disabled");
    dlEl.href = reachable;
    dlEl.download = pretty;

    // auto-click once (browser may block; user can click)
    setTimeout(()=>{ try { dlEl.click(); } catch {} }, 200);

    // informational note (no auto-delete here)
    hintEl.style.display = "block";
    hintEl.textContent = "If the browser blocks the first attempt, click the Download button again.";
  }, 900);
})();
</script>

<!-- STAMP: DSN_csv_trigger 20251029161641 -->
<div id="stamp" style="position:fixed;right:8px;bottom:8px;font:12px/1.2 monospace;color:#999;">STAMP 20251029161641</div>
