<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<title>DSN CSV Export</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:2rem;line-height:1.45}
  .wrap{max-width:780px}
  h1{margin:0 0 .5rem 0}
  .muted{color:#666}
  .row{margin:1rem 0}
  .btn{display:inline-block;padding:.6rem 1rem;border:1px solid #ddd;border-radius:8px;text-decoration:none;cursor:pointer}
  .btn[aria-disabled="true"]{opacity:.5;pointer-events:none}
  .ok{color:#0a6}
  .err{color:#b00}
  .bar{position:relative;height:8px;background:#eee;border-radius:6px;overflow:hidden}
  .bar>span{position:absolute;left:0;top:0;bottom:0;width:40%}
  .anim .bar>span{
    animation: indet 1.2s linear infinite;
    background: linear-gradient(90deg, rgba(180,180,180,.2), rgba(180,180,180,.6), rgba(180,180,180,.2));
  }
  @keyframes indet { 0%{transform:translateX(-100%)} 100%{transform:translateX(260%)} }
  .done .bar>span{animation:none;background:#cfeadf;width:100%;transform:none}
  .hint{font-size:.9rem;color:#666}
</style>

<div class="wrap anim" id="wrap">
  <h1>DSN CSV Export</h1>
  <div class="muted" id="desc">Preparing‚Ä¶</div>
  <div class="row"><div class="bar"><span></span></div></div>
  <div class="row">
    <a id="download" class="btn" href="#" aria-disabled="true" rel="noopener">‚¨á Download CSV</a>
    <a id="viewlog" class="btn" target="_blank" rel="noopener" style="display:none;">ü™µ View log</a>
    <a id="retry" class="btn" href="#" style="display:none;">‚Üª Retry</a>
  </div>
  <div class="row muted" id="status">Waiting for job to start‚Ä¶</div>
  <div class="row hint" id="hint" style="display:none;"></div>
</div>

<script>
const GH_PAGES_BASE = "https://soazcomms.github.io/";
const WEBHOOK_URL   = "https://sound-kangaroo-unlikely.ngrok-free.app/DSN_csv";

// retry config for HEAD availability checks
const HEAD_TRIES_MAX = 15;          // ~15 attempts
const HEAD_TRY_DELAY_MS = 900;      // ~0.9s each (‚âà 13‚Äì15s total worst-case)

(function(){
  const qs = new URLSearchParams(location.search);
  const label = (qs.get("label")||"").trim();
  const from  = (qs.get("from") || "").trim().split("?")[0];
  const to    = (qs.get("to")   || "").trim().split("?")[0];

  const wrap = document.getElementById("wrap");
  const statusEl = document.getElementById("status");
  const dlEl = document.getElementById("download");
  const logEl = document.getElementById("viewlog");
  const retryEl = document.getElementById("retry");
  const descEl = document.getElementById("desc");
  const hintEl = document.getElementById("hint");

  descEl.textContent = `Label: ${label} ¬∑ Range: ${from} ‚Üí ${to}`;
  const toYMD = s => String(s).slice(0,10).replaceAll("/","-");
  const yFrom = toYMD(from), yTo = toYMD(to);

  // Start job
  fetch(WEBHOOK_URL, {
    method: "POST",
    headers: { "content-type": "application/json" },
    body: JSON.stringify({ label, from: yFrom, to: yTo })
  }).then(() => {
    statusEl.textContent = "Triggered‚Ä¶ generating CSV";
  }).catch(() => {
    statusEl.textContent = "Triggered (no response)";
  });

  // Download button visible but disabled from the start
  dlEl.style.display = "inline-block";
  dlEl.setAttribute("aria-disabled","true");

  const safeLabel = (label || "").replace(/[^\w.\-]+/g, "_");
  const statusURL = `${GH_PAGES_BASE}status/status-${safeLabel}.json`;

  const headOk = async (url) => {
    try {
      const resp = await fetch(url, { method: "HEAD", cache: "no-store" });
      return resp.ok;
    } catch { return false; }
  };

  const waitUntilReachable = async (urls) => {
    // prefer earlier urls first; cycle with retries
    for (let i = 0; i < HEAD_TRIES_MAX; i++) {
      for (const u of urls) {
        const bust = u + (u.includes("?") ? "&" : "?") + "bust=" + Date.now();
        if (await headOk(bust)) return bust; // return first that succeeds
      }
      await new Promise(r => setTimeout(r, HEAD_TRY_DELAY_MS));
    }
    return ""; // none became reachable
  };

  const poll = setInterval(async () => {
    let data;
    try {
      const resp = await fetch(`${statusURL}?bust=${Date.now()}`, { cache: "no-store" });
      if (!resp.ok) return;
      data = await resp.json();
    } catch { return; }

    // Optional: show log link while running
    if (data.log) {
      const logAbs = /^https?:\/\//i.test(data.log) ? data.log
                    : GH_PAGES_BASE + String(data.log).replace(/^\/+/, "");
      logEl.href = `${logAbs}${logAbs.includes("?") ? "&" : "?"}bust=${Date.now()}`;
      logEl.style.display = "inline-block";
    }

    const phase = (data.phase || "").toLowerCase();

    if (phase === "error") {
      clearInterval(poll);
      wrap.classList.remove("anim"); wrap.classList.add("done");
      statusEl.innerHTML = `<span class="err">‚ùå Failed.</span> ${data.note||""}`;
      retryEl.style.display = "inline-block";
      retryEl.onclick = e => { e.preventDefault(); location.reload(); };
      return;
    }

    if (phase && phase !== "done") {
      wrap.classList.add("anim");
      statusEl.textContent = data.note ? `‚öôÔ∏è ${data.note}` : "‚öôÔ∏è Working‚Ä¶";
      return;
    }

    if (phase === "done") {
      clearInterval(poll);
      wrap.classList.remove("anim"); wrap.classList.add("done");
      statusEl.innerHTML = '<span class="ok">‚úÖ CSV ready.</span>';

      // Build candidates silently (prefer RAW, then Pages)
      const pagesAbs = data.csv
        ? (/^https?:\/\//i.test(data.csv) ? data.csv
           : GH_PAGES_BASE.replace(/\/+$/, "") + "/" + String(data.csv).replace(/^\/+/, ""))
        : "";
      const rawAbs = data.csv_raw || "";
      const candidates = [rawAbs, pagesAbs].filter(Boolean);

      // Friendly, non-technical copy while we wait for CDN
      hintEl.style.display = "block";
      hintEl.textContent = "Finalizing‚Ä¶";

      // Wait until one of the candidates is actually reachable
      waitUntilReachable(candidates).then((href) => {
        if (!href) {
          statusEl.innerHTML = '<span class="err">‚ùå Ready, but file not yet published. Try again.</span>';
          retryEl.style.display = "inline-block";
          return;
        }
        // Enable download
        const pretty = `${label}_${yFrom}_${yTo}.csv`;
        dlEl.removeAttribute("aria-disabled");
        dlEl.download = pretty;
        dlEl.href = href;
        hintEl.textContent = "Ready to download.";

        // Cleanup AFTER user clicks download (fire-and-forget)
        dlEl.onclick = async (e) => {
          if (dlEl.getAttribute("aria-disabled") === "true") { e.preventDefault(); return; }
          setTimeout(async () => {
            try {
              await fetch(WEBHOOK_URL + "/cleanup", {
                method: "POST",
                headers: { "content-type": "application/json" },
                body: JSON.stringify({ label, from: yFrom, to: yTo })
              });
            } catch {}
          }, 7000);
        };
      });
    }
  }, 900);
})();
</script>
</html>

<!-- STAMP: DSN_csv_trigger 20251029170729 -->
<div id="stamp" style="position:fixed;right:8px;bottom:8px;font:12px/1.2 monospace;color:#999;">STAMP 20251029170729</div>
