<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<title>DSN CSV Export</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:20px;line-height:1.45}
  .wrap{max-width:780px}
  h1{margin:0 0 .5rem 0}
  .muted{color:#666}
  .row{margin:1rem 0}
  .btn{display:inline-block;padding:.6rem 1rem;border:1px solid #ddd;border-radius:8px;text-decoration:none;cursor:pointer}
  .btn.disabled{opacity:.5;pointer-events:none}
  .ok{color:#0a6}
  .err{color:#b00}
  /* keep your existing bar look/size/colors */
  .bar{height:14px;background:#222;border-radius:7px;overflow:hidden;outline:2px solid #900}
  .bar>span{display:block;height:100%;width:0%;
            background:#ff1744;box-shadow:0 0 6px #ff1744,0 0 12px #ff1744;transition:width .45s ease}
  .done .bar>span{background:#18c37e;box-shadow:0 0 6px #18c37e,0 0 12px #18c37e}
  .hint{font-size:.9rem;color:#666}
</style>

<div class="wrap" id="wrap">
  <h1>DSN CSV Export</h1>
  <div class="muted" id="desc">Preparing‚Ä¶</div>

  <div class="row"><div class="bar"><span id="bar"></span></div></div>

  <div class="row">
    <a id="download" class="btn disabled" href="#">‚¨á Download CSV</a>
    <a id="viewlog" class="btn disabled" target="_blank" rel="noopener" href="#">ü™µ View log</a>
    <a id="retry" class="btn" href="#" style="display:none;">‚Üª Retry</a>
  </div>

  <div class="row muted" id="status">‚öôÔ∏è Working‚Ä¶</div>
  <div class="row hint" id="hint" style="display:none;"></div>
</div>

<script>
(() => {
  // --- constants ---
  const GH_PAGES_BASE = "https://soazcomms.github.io";
  const GH_RAW_BASE   = "https://raw.githubusercontent.com/soazcomms/soazcomms.github.io/main";
  const WEBHOOK_URL   = "https://sound-kangaroo-unlikely.ngrok-free.app/DSN_csv";
  const CLEANUP_URL   = "https://sound-kangaroo-unlikely.ngrok-free.app/DSN_cleanup";

  // --- qs / dom ---
  const qs      = new URLSearchParams(location.search);
  const label   = (qs.get("label")||"").trim();
  const fromQ   = (qs.get("from") || "").trim();
  const toQ     = (qs.get("to")   || "").trim();

  const wrapEl  = document.getElementById("wrap");
  const statusEl= document.getElementById("status");
  const barEl   = document.getElementById("bar");
  const dlEl    = document.getElementById("download");
  const logEl   = document.getElementById("viewlog");
  const retryEl = document.getElementById("retry");
  const descEl  = document.getElementById("desc");
  const hintEl  = document.getElementById("hint");

  const toYMD = s => String(s).slice(0,10).replaceAll("/","-");
  const yFrom = toYMD(fromQ), yTo = toYMD(toQ);
  descEl.textContent = `Label: ${label} ¬∑ Range: ${yFrom} ‚Üí ${yTo}`;

  const yFromC = yFrom.replaceAll("-","");
  const yToC   = yTo.replaceAll("-","");
  const safeLabel = (label||"").replace(/[^\w.\-]+/g, "_");

  // progress bar (unchanged visuals)
  let pct=8, ticks=0, lastTs=0;
  barEl.style.width = pct + "%";
  const tTick=setInterval(()=>{ pct=Math.min(95,pct+1+Math.min(6,Math.floor(ticks/5))); barEl.style.width=pct+"%"; ticks++; }, 900);

  // minimal helpers
  const bust = u => u + (u.includes("?") ? "&" : "?") + "bust=" + Date.now();
  const setDisabled = (a, dis=true) => {
    if (dis) { a.classList.add("disabled"); a.setAttribute("aria-disabled","true"); }
    else { a.classList.remove("disabled"); a.removeAttribute("aria-disabled"); }
  };
  const toAbs = (maybe, base) => {
    if (!maybe) return null;
    if (/^https?:\/\//i.test(maybe)) return maybe;
    return base.replace(/\/+$/,"") + "/" + String(maybe).replace(/^\/+/,"");
  };

  // kick server job (idempotent)
  fetch(WEBHOOK_URL, {
    method: "POST",
    headers: {"content-type":"application/json"},
    body: JSON.stringify({ label, from: yFrom, to: yTo })
  }).then(()=>{ statusEl.textContent = "Triggered‚Ä¶ generating CSV"; })
    .catch(()=>{ statusEl.textContent = "Triggered (no response)"; });

  // status json (RAW first for freshness; fallback to Pages if needed)
  const statusRel = `status/status-${safeLabel}.json`;
  const rawStatus = `${GH_RAW_BASE}/${statusRel}`;
  const pgStatus  = `${GH_PAGES_BASE}/${statusRel}`;

  async function getStatus() {
    try { const r = await fetch(bust(rawStatus), { cache:"no-store" }); if (r.ok) return await r.json(); } catch {}
    try { const r = await fetch(bust(pgStatus),  { cache:"no-store" }); if (r.ok) return await r.json(); } catch {}
    return null;
  }

  // wire buttons after phase===done; do NOT pre-probe CSV/log (avoids CORS/CDN stalls)
  function enableLog(url) {
    if (!url) return;
    logEl.href = bust(url);
    setDisabled(logEl, false);
  }

  function enableDownload(urls) {
    if (!urls || !urls.length) return;
    setDisabled(dlEl, false);
    dlEl.onclick = async (e)=>{
      e.preventDefault();
      statusEl.textContent = "Preparing download‚Ä¶";
      const pretty = `${safeLabel}_${yFrom}_${yTo}.csv`;

      // try candidates in order; first success wins
      let lastTried = "";
      for (const u of urls) {
        try {
          lastTried = u;
          const r = await fetch(bust(u), { method:"GET", cache:"no-store", redirect:"follow" });
          if (!r.ok) continue;
          const blob = await r.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url; a.download = pretty;
          document.body.appendChild(a); a.click();
          setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 250);

          // cleanup after successful download (best-effort)
          statusEl.textContent = "üßπ Cleaning up‚Ä¶";
          fetch(CLEANUP_URL, {
            method:"POST",
            headers:{"content-type":"application/json"},
            body: JSON.stringify({ label, from: yFrom, to: yTo })
          }).catch(()=>{});
          wrapEl.classList.add("done");
          barEl.style.width="100%";
          statusEl.innerHTML = '<span class="ok">‚úÖ CSV downloaded.</span>';
          return;
        } catch {}
      }
      statusEl.innerHTML = `‚ö†Ô∏è Download failed: HTTP 404<br><small>Last tried: <code>${lastTried}</code></small>`;
    };
  }

  const tPoll = setInterval(async ()=>{
    const data = await getStatus();
    if (!data) { statusEl.textContent = "‚öôÔ∏è Working‚Ä¶"; return; }

    if (data.timestamp && data.timestamp !== lastTs) {
      lastTs = data.timestamp; pct = Math.min(97, pct+2); barEl.style.width = pct + "%";
    }

    const phase = String(data.phase||"").toLowerCase();

    if (phase === "error") {
      clearInterval(tPoll); clearInterval(tTick);
      barEl.style.width = "100%";
      statusEl.innerHTML = `<span class="err">‚ùå Failed.</span> ${data.status||""}`;
      retryEl.style.display="inline-block";
      retryEl.onclick=(e)=>{ e.preventDefault(); location.reload(); };
      return;
    }

    if (phase === "done") {
      clearInterval(tPoll); clearInterval(tTick);
      barEl.style.width = "100%"; wrapEl.classList.add("done");
      statusEl.innerHTML = '<span class="ok">‚úÖ CSV ready.</span>';
      hintEl.style.display = "block";
      hintEl.textContent = "If the browser blocks the first attempt, click Download again.";

      // Build candidate list strictly from status + canonical guesses (no probing)
      const rel = data.csv ? String(data.csv).replace(/^\/+/, "") : `DSNdata/${safeLabel}_${yFrom.replaceAll("-","")}_${yTo.replaceAll("-","")}.csv`;
      const candidates = [];

      // 1) use csv_raw exactly as provided (primary)
      if (data.csv_raw) candidates.push(String(data.csv_raw));

      // 2) absolute Pages URL for csv (if relative from status)
      if (data.csv) candidates.push(toAbs(data.csv, GH_PAGES_BASE));

      // 3/4) canonical guesses (RAW, then Pages)
      const guessRel = `DSNdata/${safeLabel}_${yFrom.replaceAll("-","")}_${yTo.replaceAll("-","")}.csv`;
      candidates.push(`${GH_RAW_BASE}/${guessRel}`);
      candidates.push(`${GH_PAGES_BASE}/${guessRel}`);

      enableDownload(Array.from(new Set(candidates.filter(Boolean))));

      // Log button: show without probing (use status first, then common guess)
      const logCandidates = [];
      if (data.log_raw) logCandidates.push(String(data.log_raw));
      if (data.log)     logCandidates.push(toAbs(data.log, GH_PAGES_BASE));
      const guessLog = `logs/csv-${safeLabel}-${yFrom.replaceAll("-","")}-${yTo.replaceAll("-","")}.log`;
      logCandidates.push(`${GH_RAW_BASE}/${guessLog}`, `${GH_PAGES_BASE}/${guessLog}`);
      enableLog(logCandidates[0]);  // first candidate; no pre-probe
      return;
    }

    statusEl.textContent = "‚öôÔ∏è Working‚Ä¶";
  }, 900);
})();
</script>
</html>

<!-- STAMP: DSN_csv_trigger 20251030131151 -->
<div id="stamp" style="position:fixed;right:8px;bottom:8px;font:12px/1.2 monospace;color:#999;">STAMP 20251030131151</div>
