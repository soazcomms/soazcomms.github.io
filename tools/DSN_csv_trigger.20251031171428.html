<!doctype html>
<meta charset="utf-8" />
<title>DSN CSV Export</title>
<style>
  body { font: 14px/1.4 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 24px; }
  h1 { margin: 0 0 8px; font-size: 18px; }
  .muted { color: #666; margin: 0 0 16px; }
  .row { display: flex; align-items: center; gap: 12px; margin: 10px 0; }
  .btn { display:inline-block; padding: 8px 12px; border-radius:6px; background:#0b5; color:#fff; text-decoration:none; opacity:.6; pointer-events:none; }
  .btn.enabled { opacity:1; pointer-events:auto; }
  .btn.gray { background:#555; }
  .bar { position:relative; width:480px; height:10px; background:#eee; border-radius:5px; overflow:hidden; }
  .bar > i { position:absolute; top:0; left:0; bottom:0; width:0%; background:#e33; transition: width .25s linear; }
  .status { margin-top:10px; }
</style>
<h1>DSN CSV Export</h1>
<div class="muted" id="subtitle"></div>
<div class="row">
  <a id="dl" class="btn" target="_blank" rel="noopener">‚¨á Download CSV</a>
  <a id="log" class="btn gray" target="_blank" rel="noopener">ü™µ View log</a>
  <a id="retry" class="btn gray" rel="noopener">‚Üª Retry</a>
</div>
<div class="bar"><i id="bar"></i></div>
<div class="status" id="status">‚öôÔ∏è Working‚Ä¶</div>

<script>
(async () => {
  const PAGES_BASE = "https://soazcomms.github.io/";
  const params = new URLSearchParams(location.search);
  const label  = params.get("label") || "";
  const from   = (params.get("from") || "").slice(0,10);
  const to     = (params.get("to")   || "").slice(0,10);
  const bust   = () => Date.now().toString();

  const subtitle = document.getElementById("subtitle");
  const dlEl = document.getElementById("dl");
  const logEl = document.getElementById("log");
  const retryEl = document.getElementById("retry");
  const barEl = document.getElementById("bar");
  const statusEl = document.getElementById("status");

  function setBar(p){ barEl.style.width = Math.max(0, Math.min(100, p)) + "%"; }
  function enable(a, href){ a.classList.add("enabled"); if(href) a.href = href; }
  function disable(a){ a.classList.remove("enabled"); a.removeAttribute("href"); }

  subtitle.textContent = `Label: ${label} ¬∑ Range: ${from} ‚Üí ${to}`;
  disable(dlEl); disable(logEl);
  retryEl.addEventListener("click", () =>
    location.href = location.href.replace(/([?&])_=\d+/, "$1_=" + bust())
  );

  const POST = (path, body) =>
    fetch(`http://localhost:8050${path}`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });

  const turd = (step, note="") =>
    POST("/DSN_turd", { step, label, from, to, note });

  // 1) Kick off CSV generation
  setBar(5); statusEl.textContent = "‚öôÔ∏è Working‚Ä¶";
  await turd("page_load", "start");
  let gen;
  try {
    const r = await POST("/DSN_csv", { label, from, to });
    gen = await r.json();
  } catch(e) {
    statusEl.textContent = "‚ùå Generator call failed.";
    await turd("gen_call_failed", String(e));
    return;
  }
  if(!gen.ok){
    statusEl.textContent = "‚ùå " + (gen.error || "Generator error");
    await turd("gen_error", gen.error||"");
    return;
  }

  const csvRel  = gen.csv; // DSNdata/<file>.csv
  const csvRaw  = `https://raw.githubusercontent.com/soazcomms/soazcomms.github.io/main/${csvRel}`;
  const csvPages= PAGES_BASE + csvRel;

  await turd("gen_ok", csvRel);

  // ‚úÖ FIX: Activate the LOG button as soon as status is being published
  const statusHref = PAGES_BASE + `status/status-${encodeURIComponent(label)}.json?bust=${bust()}`;
  enable(logEl, statusHref);

  // Prepare Download button href (we‚Äôll use RAW for reliability)
  enable(dlEl, csvRaw + "?bust=" + bust());

  // 2) Poll status until phase === "done" and confirm availability (RAW first)
  async function pollReady(maxSec=90){
    const t0 = Date.now();
    while(true){
      setBar(20 + Math.min(50, (Date.now()-t0)/1000*0.8));
      const sURL = PAGES_BASE + `status/status-${encodeURIComponent(label)}.json?bust=${bust()}`;
      const s = await fetch(sURL, {cache:"no-store"}).then(r=>r.ok?r.json():null).catch(()=>null);
      if(s && s.phase === "done" && s.csv === csvRel){
        const raw = await fetch(csvRaw + "?bust=" + bust(), { method:"HEAD", cache:"no-store" });
        if(raw.ok) return "raw";
        const pg = await fetch(csvPages + "?bust=" + bust(), { method:"HEAD", cache:"no-store" });
        if(pg.ok) return "pages";
      }
      if((Date.now()-t0)/1000 > maxSec) return null;
      await new Promise(r => setTimeout(r, 1000));
    }
  }

  statusEl.textContent = "‚¨á CSV ready. Click Download when enabled.";
  const avail = await pollReady(90);
  if(!avail){ statusEl.textContent = "‚ö†Ô∏è CSV published but CDN not visible yet. You can still try Raw URL."; }
  setBar(75);

  // 3) Download (RAW), then request cleanup and poll for phase === "cleaned"
  dlEl.addEventListener("click", async (e) => {
    if(!dlEl.classList.contains("enabled")) return;
    e.preventDefault();
    await turd("download_click", "start");
    // trigger browser download
    location.href = csvRaw + "?bust=" + bust();

    setBar(80); statusEl.textContent = "üßπ Cleaning up‚Ä¶";
    const cu = await (await POST("/DSN_cleanup", { csv: csvRel })).json().catch(()=>({ok:false}));
    if(!cu.ok){
      statusEl.textContent = "‚ö†Ô∏è Cleanup request failed.";
      await turd("cleanup_sent_fail", JSON.stringify(cu));
      return;
    }
    await turd("cleanup_sent_ok", csvRel);

    async function pollClean(maxSec=120){
      const t0 = Date.now();
      while(true){
        setBar(80 + Math.min(20, (Date.now()-t0)/1000*0.2));
        const sURL = PAGES_BASE + `status/status-${encodeURIComponent(label)}.json?bust=${bust()}`;
        const s = await fetch(sURL, {cache:"no-store"}).then(r=>r.ok?r.json():null).catch(()=>null);
        if(s && s.phase === "cleaned"){ return true; }
        if((Date.now()-t0)/1000 > maxSec){
          await turd("cleanup_timeout","raw+pages cache linger");
          return false;
        }
        await turd("cleanup_check", "try " + Math.ceil((Date.now()-t0)/1000));
        await new Promise(r => setTimeout(r, 1000));
      }
    }

    const cleaned = await pollClean(120);
    if(cleaned){
      setBar(100);
      statusEl.textContent = "üßπ Cleanup complete.";
      await turd("cleanup_done", "");
      disable(dlEl); // hide download after successful cleanup
    }else{
      statusEl.textContent = "‚ö†Ô∏è Cleanup requested (status not confirmed yet).";
    }
  }, { once:true });
})();
</script>

<!-- STAMP: DSN_csv_trigger 20251031171428 -->
<div id="stamp" style="position:fixed;right:8px;bottom:8px;font:12px/1.2 monospace;color:#999;">STAMP 20251031171428</div>
