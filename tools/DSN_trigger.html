<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>üî¨ DSN Analysis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="Cache-Control" content="no-store, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root { --primary:#007bff; --accent:#87CEFA; --ok:#2e7d32; --warn:#c62828; --barbg:#edf2f7; }
    body{font:16px/1.35 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px;max-width:900px}
    h1{margin:0 0 8px 0}
    .muted{opacity:.75}
    .row{margin:10px 0}
    .btn{display:inline-block;padding:8px 12px;border-radius:8px;border:1px solid #ccc;text-decoration:none}
    .btn[disabled]{opacity:.4;pointer-events:none}
    #barwrap{height:10px;background:var(--barbg);border-radius:999px;overflow:hidden;margin:12px 0 4px 0;box-shadow:inset 0 0 0 1px #e2e8f0}
    #bar{height:100%;width:0%;background:linear-gradient(90deg,#69c,#38bdf8 40%,#22c55e 75%,#16a34a 100%);transition:width .5s ease}
    #bar.timeout{background:linear-gradient(90deg,#f59e0b,#ef4444)}
    #status{margin:8px 0;min-height:2.2em}
    #controls a{margin-right:10px}
    details{border:1px solid #e5e7eb;border-radius:8px;padding:.5rem 1rem;background:#fafafa}
    details pre{white-space:pre-wrap;word-break:break-word;background:#fff;border:1px solid #eee;border-radius:6px;padding:.75rem;max-height:260px;overflow:auto}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,monospace}
    .done{border:1px solid #dcfce7;background:#f0fdf4;border-radius:10px;padding:12px;margin-top:16px}
    .badge{display:inline-block;padding:.15rem .45rem;border-radius:6px;border:1px solid #e5e7eb;background:#f8fafc;font-size:.9rem}
  </style>
</head>
<body>
  <h1 id="title">üî¨ DSN Analysis</h1>
  <div id="header" class="muted">‚è≥ Initializing‚Ä¶ 4 <span id="jsBadge" class="badge">JS: starting</span></div>
  <div id="barwrap"><div id="bar"></div></div>
  <div class="row" id="status">Preparing‚Ä¶</div>
  <div class="row">
    <span id="elapsed">0:00</span>
    <span class="muted"> ¬∑ Timeout in <span id="timeoutLeft">7:00</span></span>
  </div>
  <div id="controls" class="row">
    <a id="viewBtn" class="btn" href="#" target="_blank" rel="noopener" disabled>üìÑ View Analysis Result</a>
    <a id="exitBtn" class="btn" href="about:blank">üîô Exit</a>
  </div>
  <details id="debug">
    <summary>üîß Debug</summary>
    <div><strong>Params</strong>: <code id="dbgParams"></code></div>
    <div><strong>Webhook base</strong>: <code id="dbgHook"></code></div>
    <div><strong>Health checks</strong>:</div>
    <pre id="dbgHealth">(pending)</pre>
    <div><strong>POST result</strong>:</div>
    <pre id="dbgPost">(pending)</pre>
    <div><strong>Status polls</strong>:</div>
    <pre id="dbgPolls">(pending)</pre>
    <div><strong>Errors</strong>:</div>
    <pre id="dbgErrors">(none)</pre>
  </details>

<script>
(function(){
  const dbgErrors = document.getElementById("dbgErrors");
  window.addEventListener("error", e => { dbgErrors.textContent += "\\n" + (e.message||e); });
  window.addEventListener("unhandledrejection", e => { dbgErrors.textContent += "\\n" + (e.reason && e.reason.message ? e.reason.message : e.reason); });

  const jsBadge = document.getElementById("jsBadge");
  function setJS(state){ jsBadge.textContent = "JS: " + state; }

  try{
    setJS("alive");

    // ------------ config ------------
    const GH_PAGES_BASE = "https://soazcomms.github.io/";
    const STATUS_DIR    = "status";
    const DEFAULT_WEBHOOK = "https://sound-kangaroo-unlikely.ngrok-free.app";
    const qs = new URLSearchParams(location.search);

    // Inputs
    const rawLabel = (qs.get("label")||"").trim();
    const fromQ    = (qs.get("from") || "").trim();
    const toQ      = (qs.get("to")   || "").trim();
    const WEBHOOK_ORIG = (qs.get("webhook") || DEFAULT_WEBHOOK).replace(/\\/+$/,"");
    const WEBHOOK_URL  = WEBHOOK_ORIG + "/DSN_trigger";

    // Helpers
    function toISO(s){ return (s.includes("T") ? s : (s + "T00:00:00.000Z")); }
    function onlyDate(s){ return (s||"").split("T")[0]; }
    function safeShort(lbl){ return (lbl||"").split("_")[0].replace(/[^\\w.\\-]/g,"_"); }
    function safeFull(lbl){  return (lbl||"").replace(/[^\\w.\\-]/g,"_"); }
    function bust(u){ return u + (u.includes("?")?"&":"?") + "bust=" + Date.now(); }
    function mmss(ms){ const s=Math.max(0,Math.floor(ms/1000)); return `${Math.floor(s/60)}:${String(s%60).padStart(2,"0")}`; }

    // DOM
    const statusEl  = document.getElementById("status");
    const headerEl  = document.getElementById("header");
    const titleEl   = document.getElementById("title");
    const bar       = document.getElementById("bar");
    const elapsedEl = document.getElementById("elapsed");
    const leftEl    = document.getElementById("timeoutLeft");
    const viewBtn   = document.getElementById("viewBtn");

    const dbgParams = document.getElementById("dbgParams");
    const dbgHook   = document.getElementById("dbgHook");
    const dbgHealth = document.getElementById("dbgHealth");
    const dbgPost   = document.getElementById("dbgPost");
    const dbgPolls  = document.getElementById("dbgPolls");

    // Validation
    if (!rawLabel || !fromQ || !toQ){
      statusEl.innerHTML = "‚ùå Missing label/from/to.";
      headerEl.textContent = "DSN Analysis ‚Äî (missing params)";
      document.title = "üî¨ DSN Analysis ‚Äî missing params";
      setJS("alive (params missing)");
      return;
    }

    // Normalize
    const fromIso = toISO(fromQ);
    const toIso   = toISO(toQ);
    const label8  = safeShort(rawLabel);
    const labelFull = safeFull(rawLabel);

    document.title = `üî¨ DSN Analysis ‚Äî ${rawLabel}`;
    titleEl.textContent = `üî¨ DSN Analysis ‚Äî ${rawLabel}`;
    headerEl.textContent = `Label: ${rawLabel} ¬∑ Range: ${onlyDate(fromIso)} ‚Üí ${onlyDate(toIso)}`;

    // Status URLs
    const statusUrls = [
      `${GH_PAGES_BASE}${STATUS_DIR}/status-${encodeURIComponent(labelFull)}.json`,
      `${GH_PAGES_BASE}${STATUS_DIR}/status-${encodeURIComponent(label8)}.json`,
    ];

    // Debug fill
    dbgParams.textContent = JSON.stringify({label: rawLabel, from: fromIso, to: toIso});
    dbgHook.textContent   = JSON.stringify({webhook_base: WEBHOOK_ORIG, post_url: WEBHOOK_URL});

    // Timers
    const HARD_TIMEOUT_MS = 7 * 60 * 1000;
    const startTs = Date.now();
    let timedOutShown = false;
    let timersActive = true;

    function stopAllTimers(){
      if (!timersActive) return;
      timersActive = false;
      clearInterval(tIv);
      clearInterval(pIv);
    }

    function tickTime(){
      const t = Date.now()-startTs;
      const m = Math.floor(t/60000), s = Math.floor((t%60000)/1000);
      elapsedEl.textContent = `${m}:${String(s).padStart(2,"0")}`;
      const left = Math.max(0, HARD_TIMEOUT_MS - t);
      leftEl.textContent = mmss(left);
      const pct = Math.min(99, Math.floor((t/HARD_TIMEOUT_MS)*100));
      bar.style.width = pct + "%";
      if (left === 0 && !timedOutShown){ bar.classList.add("timeout"); timedOutShown = true; }
    }
    const tIv = setInterval(tickTime, 1000); tickTime();

    // Health checks
    async function healthChecks(){
      setJS("probing");
      const targets = [
        {name:"/health", url: WEBHOOK_ORIG + "/health"},
        {name:"/DSN_trigger?ping=1", url: WEBHOOK_URL + "?ping=1"},
        {name:"/log?msg=client_start&label="+encodeURIComponent(rawLabel), url: WEBHOOK_ORIG + "/log?msg=client_start&label="+encodeURIComponent(rawLabel)}
      ];
      const lines = [];
      for (const t of targets){
        try{
          const r = await fetch(t.url, {method:"GET", cache:"no-store", mode:"cors", credentials:"omit"});
          let body="";
          try{ body = await r.text(); }catch(_){}
          lines.push(`${t.name}: HTTP ${r.status} ${r.statusText} body=${(body||"").slice(0,160)}`);
        }catch(e){
          lines.push(`${t.name}: NETWORK ERROR (${e && e.message ? e.message : e})`);
        }
      }
      dbgHealth.textContent = lines.join("\\n");
      setJS("posting");
    }

    // Kick job
    let posted = false;
    async function startJobOnce(){
      if (posted) return; posted = true;
      const payload = { label: rawLabel, from: fromIso, to: toIso };
      try{
        const resp = await fetch(WEBHOOK_URL, {
          method: "POST",
          mode: "cors",
          credentials: "omit",
          cache: "no-store",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(payload)
        });
        let body="";
        try{ body = await resp.text(); }catch(_){}
        dbgPost.textContent = `HTTP ${resp.status} ${resp.statusText}\\n${(body||"").slice(0,2000)}`;
        if (!resp.ok){
          statusEl.innerHTML = `‚ùå Job failed to start (HTTP ${resp.status}).`;
          bar.style.width = "100%";
          stopAllTimers();
          setJS("error");
          return;
        }
        statusEl.textContent = "‚è≥ Running analysis‚Ä¶";
        setJS("polling");
      }catch(e){
        dbgPost.textContent = `NETWORK ERROR: ${e && e.message ? e.message : e}`;
        statusEl.textContent = "‚ùå Could not reach webhook.";
        bar.style.width = "100%";
        stopAllTimers();
        setJS("error");
      }
    }

    // Poll
    async function fetchNewestWithHtml(){
      const found = [];
      const logs = [];
      await Promise.all(statusUrls.map(async (u) => {
        try{
          const r = await fetch(bust(u), {cache:"no-store"});
          logs.push(`${u} -> HTTP ${r.status}`);
          if (!r.ok) return;
          const j = await r.json();
          const ts = Number(j.timestamp)||0;
          const hasHtml = !!(j.html && String(j.html).trim());
          logs.push(`  json: ts=${ts} html=${hasHtml?'yes':'no'} phase=${j.phase||''} status=${(j.status||'').slice(0,80)}`);
          if (hasHtml) found.push({data:j, ts});
        }catch(e){
          logs.push(`${u} -> ERROR ${e && e.message ? e.message : e}`);
        }
      }));
      dbgPolls.textContent = logs.join("\\n");
      if (!found.length) return null;
      found.sort((a,b)=> b.ts - a.ts);
      return found[0].data;
    }

    function showDone(statusText, href){
      stopAllTimers();
      bar.style.width = "100%";
      viewBtn.removeAttribute("disabled");
      viewBtn.href = href;
      statusEl.innerHTML = statusText || "‚úÖ Analysis complete.";
      headerEl.textContent += " ‚Äî DONE";
      document.title = "‚úÖ DSN Analysis ‚Äî finished";
      const card = document.createElement("div");
      card.className = "done";
      card.innerHTML = `‚úÖ Finished. <a href="${href}" target="_blank" rel="noopener">Open result</a>. This page is idle and can be closed.`;
      document.getElementById("controls").replaceWith(card);
      try{ window.stop && window.stop(); }catch(_){}
      setJS("done");
    }

    async function pollStatus(){
      try{
        const data = await fetchNewestWithHtml();
        if (!data){ statusEl.innerHTML = "‚è≥ Generating plots‚Ä¶"; return; }
        if (data.phase === "error"){
          stopAllTimers();
          statusEl.innerHTML = data.status || "‚ùå Analysis failed.";
          bar.style.width = "100%";
          setJS("error");
          return;
        }
        const htmlRel = String(data.html||"").trim();
        if (!htmlRel){ statusEl.innerHTML = "‚è≥ Generating plots‚Ä¶"; return; }
        const href = GH_PAGES_BASE + htmlRel.replace(/^\\/+/, "");
        showDone(data.status, href);
      }catch(e){
        dbgErrors.textContent += "\\n poll error: " + (e && e.message ? e.message : e);
      }
    }
    const pIv = setInterval(pollStatus, 1500);

    // Kick off
    healthChecks();
    startJobOnce();

    // Timeout
    setTimeout(function(){
      if (!timersActive) return;
      stopAllTimers();
      bar.style.width = "100%";
      const now = statusEl.textContent || statusEl.innerHTML || "";
      if (!/complete/i.test(now)){
        statusEl.innerHTML = "‚ùå Timed out waiting for analysis.";
      }
      setJS("timeout");
    }, HARD_TIMEOUT_MS);

  }catch(e){
    setJS("crashed");
    dbgErrors.textContent += "\\n fatal: " + (e && e.message ? e.message : e);
  }
})();
</script>
</body>
</html>
