<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>DSN Analysis</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%, #000 100%);
      color: #e5e7eb;
    }
    .card {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 1.25rem;
      padding: 1.5rem 1.75rem 1.75rem;
      box-shadow: 0 24px 80px rgba(15, 23, 42, 0.85);
      max-width: 720px;
      width: min(720px, 100% - 2rem);
      border: 1px solid rgba(148, 163, 184, 0.25);
    }
    h1 {
      margin: 0 0 0.35rem;
      font-size: 1.2rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #a5b4fc;
    }
    #siteLine {
      font-size: 0.9rem;
      color: #e5e7eb;
      margin-bottom: 0.75rem;
    }
    #status {
      margin: 0.4rem 0 0.9rem;
      font-size: 0.98rem;
    }
    .muted {
      color: #9ca3af;
    }
    .bar-wrap {
      width: 100%;
      margin: 0.35rem 0 0.5rem;
    }
    .bar-bg {
      width: 100%;
      height: 0.5rem;
      border-radius: 999px;
      background: rgba(30, 64, 175, 0.5);
      overflow: hidden;
    }
    .bar-fill {
      width: 0%;
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, #60a5fa, #22c55e);
      transition: width 0.35s linear;
    }
    #timersRow {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 0.9rem;
    }
    .btn-row {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.35rem;
      padding: 0.45rem 0.9rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 0.85rem;
      text-decoration: none;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.08s ease;
    }
    .btn[disabled] {
      opacity: 0.4;
      cursor: default;
      pointer-events: none;
    }
    .btn:hover:not([disabled]) {
      background: rgba(30, 64, 175, 0.9);
      border-color: rgba(129, 140, 248, 0.9);
      transform: translateY(-0.5px);
    }
    .btn.secondary:hover:not([disabled]) {
      background: rgba(31, 41, 55, 0.95);
      border-color: rgba(148, 163, 184, 0.9);
    }
    .ok {
      color: #4ade80;
    }
    .err {
      color: #f97373;
    }
  </style>
</head>
<body>
  <main class="card">
    <h1>üî¨ DSN Analysis V.46</h1>
    <div id="siteLine" class="muted">Initializing‚Ä¶</div>
    <div id="status">‚è≥ Preparing‚Ä¶</div>

    <div class="bar-wrap">
      <div class="bar-bg">
        <div class="bar-fill" id="barFill"></div>
      </div>
    </div>

    <div id="timersRow">‚è± 0:00 ¬∑ Timeout in 7:00</div>

    <div class="btn-row">
      <a id="viewBtn" class="btn" href="#" target="_blank" rel="noopener" disabled>üìÑ View Analysis Result</a>
      <a id="exitBtn" class="btn secondary" href="#" onclick="window.close(); return false;">üîô Exit</a>
    </div>
  </main>

  <script>
  (function(){
    // ---------- CONSTANTS ----------
    const WORKER_URL       = "https://dsn-analysis.dsn-analysis.workers.dev/";
    const GH_RAW_BASE      = "https://raw.githubusercontent.com/soazcomms/soazcomms.github.io/main/";
    const TIMEOUT_SECONDS  = 7 * 60;
    const POLL_INTERVAL_MS = 5000;

    // ---------- DOM ----------
    const statusEl   = document.getElementById("status");
    const siteLineEl = document.getElementById("siteLine");
    const barFill    = document.getElementById("barFill");
    const timersRow  = document.getElementById("timersRow");
    const viewBtn    = document.getElementById("viewBtn");

    // ---------- STATE ----------
    let elapsedSec = 0;
    let timerId    = null;
    let pollId     = null;
    let done       = false;
    let rawLabel   = "";
    let fromStr    = "";
    let toStr      = "";
    let markerUrl  = null;  // /analysis/<LABEL>/files_YYMMDD_YYMMDD
    const sessionStartTs = Math.floor(Date.now() / 1000); // for stale JSON detection

    // ---------- HELPERS ----------
    function parseParams(){
      const u = new URL(window.location.href);
      const sp = u.searchParams;
      const label = (sp.get("label") || "").trim();
      const from  = (sp.get("from")  || "").trim();
      const to    = (sp.get("to")    || "").trim();
      return { label, from, to };
    }

    function justDate(s){
      if (!s) return "";
      return s.split(" ")[0];
    }

    function mmss(sec){
      sec = Math.max(0, Math.floor(sec));
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return m + ":" + String(s).padStart(2, "0");
    }

    function statusMsg(msg) {
      statusEl.textContent = msg;
    }

    function startTimers(){
      elapsedSec = 0;
      timersRow.textContent = "‚è± 0:00 ¬∑ Timeout in " + mmss(TIMEOUT_SECONDS);
      barFill.style.width = "0%";
      timerId = window.setInterval(function(){
        if (done) return;
        elapsedSec += 1;
        const remaining = Math.max(0, TIMEOUT_SECONDS - elapsedSec);
        timersRow.textContent =
          "‚è± " + mmss(elapsedSec) + " ¬∑ Timeout in " + mmss(remaining);
        const pct = Math.max(0, Math.min(100, (elapsedSec / TIMEOUT_SECONDS) * 100));
        barFill.style.width = pct.toFixed(1) + "%";
        if (remaining <= 0 && !done) {
          statusEl.innerHTML = "<span class='err'>‚ùå Timed out waiting for analysis.</span>";
          stopAllTimers();
        }
      }, 1000);
    }

    function stopAllTimers(){
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
      if (pollId) {
        clearInterval(pollId);
        pollId = null;
      }
    }

    function buildStatusUrl(label){
      return GH_RAW_BASE + "status/status-" + encodeURIComponent(label) +
             ".json?ts=" + Date.now();
    }

    // Turn "YYYY-MM-DD ..." into "YYMMDD" (e.g. 2025-03-31 -> 250331)
    function toYYMMDD(dateTime){
      if (!dateTime) return "";
      const d = dateTime.split(" ")[0];      // "YYYY-MM-DD"
      const parts = d.split("-");
      if (parts.length !== 3) return "";
      const y = parts[0];
      const m = parts[1].padStart(2, "0");
      const day = parts[2].padStart(2, "0");
      const yy = y.slice(-2);
      return yy + m + day;
    }

    // Ensure html -> absolute URL
    function buildHtmlHref(htmlField){
      if (!htmlField) return null;
      let s = String(htmlField).trim();
      if (!s) return null;
      if (s.startsWith("http://") || s.startsWith("https://")) {
        return s;
      }
      if (!s.startsWith("/")) {
        s = "/" + s;
      }
      return window.location.origin + s;
    }

    function showDone(text, href){
      done = true;
      barFill.style.width = "100%";
      statusEl.innerHTML = text || "<span class='ok'>‚úÖ Analysis complete.</span>";
      if (viewBtn && href) {
        viewBtn.removeAttribute("disabled");
        viewBtn.href = href;
      }
      stopAllTimers();
    }

    // ---------- POLLING ----------
    async function pollStatus(){
      if (done || !rawLabel) return;

      let showedStatus = false;
      let jsonHtml = "";
      let jsonStat = "";

      // 1) Try status JSON
      const url = buildStatusUrl(rawLabel);
      try {
        const r = await fetch(url, { cache: "no-store" });
        if (r.status === 404) {
          // status file not yet written -> fall through to marker check
        } else if (r.ok) {
          const data = await r.json();
          const phase  = String(data.phase || "").toLowerCase();
          const stat   = data.status || "";
          const html   = data.html   || "";
          const tsRaw  = data.timestamp;
          const ts     = typeof tsRaw === "number" ? tsRaw : Number(tsRaw || 0);

          jsonHtml = html;
          jsonStat = stat;

          console.log("status JSON", data);

          // Ignore stale "done"/"publishing" from previous runs
          const isStale = ts && ts < (sessionStartTs - 5);

          if (phase.includes("publishing") && !isStale) {
            statusMsg("üöÄ Publishing results‚Ä¶");
            showedStatus = true;
            return;
          }

          if (phase.includes("done") && !isStale) {
            const href = buildHtmlHref(html || ("/analysis/" + rawLabel + "/" + rawLabel + ".analysis.html"));
            const msg  = stat || "<span class='ok'>‚úÖ Analysis complete.</span>";
            showDone(msg, href);
            return;
          }

          if (!isStale && stat) {
            statusMsg(stat);
            showedStatus = true;
          }
        } else {
          // non-404, non-OK: ignore and fall through
        }
      } catch (err) {
        console.log("pollStatus JSON error", err);
      }

      // 2) files_* marker fallback (DSN_generate_analysis.py writes this on success)
      if (!done && markerUrl) {
        try {
          const fullMarker = window.location.origin + markerUrl;
          const mr = await fetch(fullMarker, {
            method: "HEAD",
            cache: "no-store"
          });
          if (mr.ok) {
            // Marker exists => treat as done, even if JSON is missing or stale
            const href = buildHtmlHref(
              jsonHtml || ("/analysis/" + rawLabel + "/" + rawLabel + ".analysis.html")
            );
            const msg = jsonStat || "‚úÖ Analysis complete (files marker found).";
            showDone(msg, href);
            return;
          }
        } catch (err) {
          console.log("pollStatus marker error", err);
        }
      }

      // 3) If we didn't show anything this tick, keep the "running" message
      if (!done && !showedStatus) {
        statusMsg("‚è≥ Running analysis‚Ä¶");
      }
    }

    // ---------- MAIN ----------
    async function startJob(){
      console.log("JS startJob()");

      const p = parseParams();
      rawLabel = p.label;
      fromStr  = p.from;
      toStr    = p.to;

      if (!rawLabel || !fromStr || !toStr) {
        statusEl.innerHTML =
          "<span class='err'>‚ùå Missing label/from/to parameters.</span>";
        console.log("Missing params", p);
        return;
      }

      siteLineEl.textContent =
        "Site: " + rawLabel +
        " ¬∑ Range: " + justDate(fromStr) +
        " ‚Üí " + justDate(toStr);

      // Precompute files_* marker path for this range (if possible)
      const fromCode = toYYMMDD(fromStr);
      const toCode   = toYYMMDD(toStr);
      if (fromCode && toCode) {
        markerUrl = "/analysis/" + encodeURIComponent(rawLabel) +
                    "/files_" + fromCode + "_" + toCode;
      } else {
        markerUrl = null;
      }

      statusMsg("‚è≥ Triggering worker‚Ä¶");
      startTimers();

      // Start polling immediately, regardless of worker outcome
      if (!pollId) {
        pollId = window.setInterval(pollStatus, POLL_INTERVAL_MS);
        pollStatus();
      }

      const payload = { label: rawLabel, from: fromStr, to: toStr };

      try {
        const r = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!r.ok) {
          console.log("worker HTTP error", r.status);
          statusEl.innerHTML =
            "<span class='err'>‚ö†Ô∏è Could not confirm worker (HTTP " + r.status + "). Still watching for results‚Ä¶</span>";
          return;
        }

        let body = {};
        try { body = await r.json(); } catch (_) {}
        console.log("worker response", body);

        statusMsg("‚è≥ Running analysis‚Ä¶");

      } catch (err) {
        console.log("worker fetch error", err);
        statusEl.innerHTML =
          "<span class='err'>‚ö†Ô∏è Could not reach worker (network error). Still watching for results‚Ä¶</span>";
      }
    }

    document.addEventListener("DOMContentLoaded", startJob);
  })();
  </script>
</body>
</html>
