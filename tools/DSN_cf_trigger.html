<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>DSN Analysis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #05060a;
      color: #eee;
      margin: 0;
      padding: 1rem 1.5rem;
    }
    h1 {
      font-size: 1.3rem;
      margin: 0 0 0.4rem 0;
    }
    .site {
      font-size: 0.95rem;
      margin-bottom: 0.75rem;
      color: #aaa;
    }
    .status {
      margin: 0.6rem 0 0.2rem 0;
      min-height: 1.4rem;
    }
    .row {
      margin-top: 0.4rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.9rem;
    }
    .btn {
      display: inline-block;
      padding: 0.35rem 0.8rem;
      font-size: 0.9rem;
      border-radius: 999px;
      border: 1px solid #3b82f6;
      background: #0b1120;
      color: #e5e7eb;
      text-decoration: none;
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
    }
    .btn[disabled] {
      opacity: 0.4;
      cursor: default;
    }
    .btn:not([disabled]):hover {
      background: #1d4ed8;
      color: white;
    }
    .timer {
      font-variant-numeric: tabular-nums;
      font-size: 0.85rem;
      color: #a5b4fc;
    }
    .bar-wrap {
      margin-top: 0.6rem;
      margin-bottom: 0.2rem;
      width: 100%;
      max-width: 360px;
    }
    .bar {
      position: relative;
      width: 100%;
      height: 0.4rem;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.25);
      overflow: hidden;
    }
    .bar-fill {
      position: absolute;
      inset: 0;
      width: 35%;
      border-radius: inherit;
      background: linear-gradient(90deg, #60a5fa, #22c55e);
      animation: slide 1.4s ease-in-out infinite;
    }
    @keyframes slide {
      0%   { transform: translateX(-80%); }
      50%  { transform: translateX(10%); }
      100% { transform: translateX(110%); }
    }
    .note {
      margin-top: 0.4rem;
      font-size: 0.8rem;
      color: #6b7280;
    }
    .err {
      color: #fecaca;
    }
    .ok {
      color: #bbf7d0;
    }
  </style>
</head>
<body>
  <h1>üî¨ DSN Analysis V.33</h1>
  <div id="site" class="site"></div>

  <div class="status" id="status">‚è≥ Initializing‚Ä¶</div>

  <div id="barRow" class="bar-wrap">
    <div class="bar"><div class="bar-fill"></div></div>
  </div>

  <div id="timerRow" class="row">
    <div class="timer">
      ‚è± <span id="elapsed">0:00</span> ¬∑ Timeout in <span id="remaining">7:00</span>
    </div>
  </div>

  <div class="row">
    <a id="viewBtn" class="btn" href="#" target="_blank" rel="noopener" disabled>üìÑ View Analysis Result</a>
    <a id="exitBtn" class="btn" href="about:blank">üîô Exit</a>
  </div>

  <div class="note">
    This page triggers a GitHub Actions analysis via Cloudflare Worker, then waits for
    the result to be published to GitHub Pages.
  </div>

  <script>
  (function() {
    const STATUS_POLL_MS = 8000;   // 8s between polls
    const TIMEOUT_SEC    = 7 * 60; // 7 minutes

    const GH_PAGES_BASE = "https://soazcomms.github.io/";
    const GH_RAW_BASE   = "https://raw.githubusercontent.com/soazcomms/soazcomms.github.io/main/";

    const siteEl   = document.getElementById("site");
    const statusEl = document.getElementById("status");
    const elapsedEl   = document.getElementById("elapsed");
    const remainingEl = document.getElementById("remaining");
    const barRow   = document.getElementById("barRow");
    const timerRow = document.getElementById("timerRow");
    const viewBtn  = document.getElementById("viewBtn");

    let timers = [];
    function startTimer() {
      const start = Date.now();
      const total = TIMEOUT_SEC;
      function update() {
        const now   = Date.now();
        const delta = Math.floor((now - start) / 1000);
        const left  = Math.max(0, total - delta);

        const mm = Math.floor(delta / 60);
        const ss = delta % 60;
        elapsedEl.textContent = `${mm}:${ss.toString().padStart(2, "0")}`;

        const rm = Math.floor(left / 60);
        const rs = left % 60;
        remainingEl.textContent = `${rm}:${rs.toString().padStart(2, "0")}`;
      }
      update();
      timers.push(setInterval(update, 1000));
    }
    function stopAllTimers() {
      for (const t of timers) clearInterval(t);
      timers = [];
    }

    const params = new URLSearchParams(window.location.search);
    const rawLabel = (params.get("label") || "").trim();
    const fromTxt  = (params.get("from")  || "").trim();
    const toTxt    = (params.get("to")    || "").trim();

    if (!rawLabel || !fromTxt || !toTxt) {
      statusEl.innerHTML = "<span class='err'>‚ùå Missing label/from/to.</span>";
      if (barRow)   barRow.style.display   = "none";
      if (timerRow) timerRow.style.display = "none";
      return;
    }

    siteEl.textContent = `Site: ${rawLabel} ¬∑ Range: ${fromTxt.slice(0,10)} ‚Üí ${toTxt.slice(0,10)}`;

    function bust(url) {
      const u = new URL(url);
      u.searchParams.set("_cb", Date.now().toString());
      return u.toString();
    }

    // status JSON + final HTML
    const STATUS_URL = `${GH_RAW_BASE}status/status-${encodeURIComponent(rawLabel)}.json`;
    const FINAL_HTML = `${GH_PAGES_BASE}analysis/${encodeURIComponent(rawLabel)}/${encodeURIComponent(rawLabel)}.analysis.html`;

    function showDone(msg, href) {
      statusEl.innerHTML = msg || "‚úÖ Analysis complete.";
      if (viewBtn && href) {
        viewBtn.removeAttribute("disabled");
        viewBtn.href = href;
      }
      stopAllTimers();
      // NOTE: we NO LONGER hide the timer row here so the timer stays visible after finish.
    }

    async function fetchStatusJSON() {
      const resp = await fetch(bust(STATUS_URL), { cache: "no-store" });
      if (!resp.ok) {
        if (resp.status === 404) return null;
        throw new Error(`status fetch HTTP ${resp.status}`);
      }
      return await resp.json();
    }

    async function pollLoop(startMs) {
      while (true) {
        const ageSec = (Date.now() - startMs) / 1000;
        if (ageSec > TIMEOUT_SEC) {
          statusEl.innerHTML = "<span class='err'>‚è± Timed out waiting for analysis.</span>";
          stopAllTimers();
          return;
        }

        try {
          const data = await fetchStatusJSON();
          if (data && data.phase) {
            if (/error/i.test(data.phase)) {
              statusEl.innerHTML = `<span class="err">${data.status || "‚ùå Error from workflow."}</span>`;
              stopAllTimers();
              return;
            }
            if (/done/i.test(data.phase)) {
              const href = `${GH_PAGES_BASE}${data.html || ("analysis/" + encodeURIComponent(rawLabel) + "/" + encodeURIComponent(rawLabel) + ".analysis.html")}`;
              showDone(data.status || "‚úÖ Analysis complete.", href);
              return;
            }
            if (/publishing/i.test(data.phase)) {
              statusEl.textContent = "üöÄ Publishing results to GitHub Pages‚Ä¶";
            } else if (/running/i.test(data.phase)) {
              statusEl.textContent = data.status || "‚è≥ Running analysis‚Ä¶";
            } else {
              statusEl.textContent = data.status || "‚è≥ Working‚Ä¶";
            }
          } else {
            statusEl.textContent = "‚è≥ Waiting for status JSON‚Ä¶";
          }
        } catch (e) {
          statusEl.innerHTML = `<span class="err">‚ö†Ô∏è Status check failed; retrying‚Ä¶</span>`;
        }

        await new Promise(r => setTimeout(r, STATUS_POLL_MS));
      }
    }

    async function triggerWorker() {
      const workerUrl = "https://dsn-analysis.dsn-analysis.workers.dev/";
      const body = {
        label: rawLabel,
        from:  fromTxt,
        to:    toTxt
      };

      const resp = await fetch(workerUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      if (!resp.ok) {
        throw new Error(`worker HTTP ${resp.status}`);
      }
      const js = await resp.json();
      if (!js.ok) {
        throw new Error(`worker error: ${js.error || "unknown"}`);
      }
      return js;
    }

    async function startJob() {
      const startMs = Date.now();
      startTimer();
      statusEl.textContent = "‚è≥ Starting GitHub Actions workflow via Cloudflare‚Ä¶";

      try {
        await triggerWorker();
        statusEl.textContent = "‚è≥ Running analysis via GitHub Actions‚Ä¶";
      } catch (e) {
        statusEl.innerHTML = `<span class="err">‚ùå Failed to reach worker.</span>`;
        stopAllTimers();
        return;
      }

      // Only now start polling for the Pages-published status
      pollLoop(startMs);
    }

    statusEl.textContent = "‚è≥ Preparing‚Ä¶";
    startJob();

  })();
  </script>
</body>
</html>
