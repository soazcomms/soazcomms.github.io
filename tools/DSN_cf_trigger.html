<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>DSN Analysis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #05060a;
      color: #eee;
      margin: 0;
      padding: 1rem 1.5rem;
    }
    h1 {
      font-size: 1.3rem;
      margin: 0 0 0.25rem 0;
    }
    #sub {
      font-size: 0.95rem;
      margin-bottom: 0.75rem;
      color: #bbb;
    }
    .bar-wrap {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin: 0.5rem 0 0.25rem 0;
    }
    .bar {
      flex: 0 0 50%;
      height: 0.35rem;
      border-radius: 999px;
      background: #222;
      overflow: hidden;
    }
    .bar-inner {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #2dd, #4a7cff);
      transition: width 0.3s ease-out;
    }
    #timerRow {
      font-size: 0.8rem;
      color: #aaa;
      margin-bottom: 0.5rem;
    }
    #status {
      margin: 0.5rem 0 0.75rem 0;
      font-size: 0.95rem;
    }
    .btn-row {
      margin-top: 0.25rem;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .btn {
      display: inline-block;
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      border: 1px solid #555;
      background: #14151c;
      color: #eee;
      font-size: 0.85rem;
      text-decoration: none;
      cursor: pointer;
    }
    .btn[disabled] {
      opacity: 0.45;
      cursor: default;
      pointer-events: none;
    }
    .btn-primary {
      border-color: #2dd;
    }
    .ok {
      color: #7CFC00;
    }
    .err {
      color: #ff6b6b;
    }
  </style>
</head>
<body>
  <h1>üî¨ DSN Analysis V.31</h1>
  <div id="sub"></div>

  <div class="bar-wrap" id="barRow">
    <div class="bar"><div class="bar-inner" id="barInner"></div></div>
  </div>
  <div id="timerRow">‚è± <span id="timer">0:00</span> ¬∑ Timeout in 7:00</div>

  <div id="status">‚è≥ Initializing‚Ä¶</div>

  <div class="btn-row">
    <a id="viewBtn" class="btn btn-primary" href="#" target="_blank" disabled>üìÑ View Analysis Result</a>
    <button id="exitBtn" class="btn">üîô Exit</button>
  </div>

<script>
(function(){

  // ==== constants ====
  const WORKER_URL   = "https://dsn-analysis.dsn-analysis.workers.dev/";
  const GH_RAW_BASE  = "https://raw.githubusercontent.com/soazcomms/soazcomms.github.io/main/";
  const TIMEOUT_SECS = 7 * 60;   // 7 minutes

  // ---- query params ----
  const qs        = new URLSearchParams(location.search || "");
  const rawLabel  = (qs.get("label") || "").trim();
  const fromTxt   = (qs.get("from")  || "").trim();
  const toTxt     = (qs.get("to")    || "").trim();
  const cb        = (qs.get("_cb")   || "") || String(Date.now());

  // ---- DOM hooks ----
  const subEl     = document.getElementById("sub");
  const statusEl  = document.getElementById("status");
  const timerEl   = document.getElementById("timer");
  const timerRow  = document.getElementById("timerRow");
  const viewBtn   = document.getElementById("viewBtn");
  const exitBtn   = document.getElementById("exitBtn");
  const barRow    = document.getElementById("barRow");
  const barInner  = document.getElementById("barInner");

  let startedAt   = Date.now();
  let timers      = [];
  let posted      = false;
  let timedOut    = false;

  function srvlog(msg, extra) {
    const t = new Date().toISOString().replace("T"," ").replace("Z","");
    const line = `[JS ${t}] ${msg}` + (extra ? " " + JSON.stringify(extra) : "");
    console.log(line);
    // Not writing to DOM ‚Äì console only.
  }

  function stopAllTimers(){
    timers.forEach(id => clearInterval(id));
    timers = [];
  }

  function bust(url){
    const u = new URL(url);
    u.searchParams.set("_cb", String(Date.now()));
    return u.toString();
  }

  // analysis/<LABEL>/<LABEL>.analysis.html
  const FINAL_HTML  = `https://soazcomms.github.io/analysis/${encodeURIComponent(rawLabel)}/${encodeURIComponent(rawLabel)}.analysis.html`;
  const STATUS_URL  = `${GH_RAW_BASE}status/status-${encodeURIComponent(rawLabel)}.json`;

  // ---- basic validation ----
  if (!rawLabel || !fromTxt || !toTxt) {
    statusEl.innerHTML = '<span class="err">‚ùå Missing label/from/to.</span>';
    subEl.textContent  = "No job parameters provided.";
    viewBtn.setAttribute("disabled", "disabled");
    return;
  }

  // Small helper: pretty date range
  subEl.textContent = `Site: ${rawLabel} ¬∑ Range: ${fromTxt.split(" ")[0]} ‚Üí ${toTxt.split(" ")[0]}`;

  // ---- timer display + timeout + progress bar ----
  timers.push(setInterval(() => {
    if (timedOut) return;

    const dt = Math.floor((Date.now() - startedAt) / 1000);
    const m  = Math.floor(dt / 60);
    const s  = dt % 60;
    if (timerEl) timerEl.textContent = `${m}:${s.toString().padStart(2,"0")}`;

    // progress is purely time-based: 0 ‚Üí 100% over TIMEOUT_SECS
    const frac = Math.min(1, dt / TIMEOUT_SECS);
    if (barInner) {
      barInner.style.width = (frac * 100).toFixed(1) + "%";
    }

    if (dt >= TIMEOUT_SECS) {
      timedOut = true;
      statusEl.innerHTML = '<span class="err">‚ùå Timed out after 7 minutes. Check GitHub Actions / Cloudflare logs.</span>';
      if (barInner) barInner.style.width = "100%";
      stopAllTimers();  // leave timer + bar visible, frozen
    }
  }, 1000));

  // ---- EXIT button ----
  exitBtn.addEventListener("click", () => {
    try { window.close(); } catch(e) {}
    window.location.href = "about:blank";
  });

  // ---- status polling ----
  async function fetchStatusJSON(){
    try {
      const url = bust(STATUS_URL);
      const r   = await fetch(url, { cache: "no-store" });
      if (!r.ok) {
        if (r.status === 404) return null; // not written yet
        srvlog("status_fetch_error", { code: r.status });
        return null;
      }
      return await r.json();
    } catch(e) {
      srvlog("status_fetch_exception", { error: String(e) });
      return null;
    }
  }

  function showDone(msg){
    if (barInner) barInner.style.width = "100%";
    statusEl.innerHTML = `<span class="ok">${msg || "‚úÖ Analysis complete."}</span>`;
    stopAllTimers();  // timer stays, frozen at final time
  }

  async function pollLoop(){
    while (true) {
      if (timedOut) return;

      const data = await fetchStatusJSON();

      if (!data) {
        statusEl.textContent = "‚è≥ Waiting for GitHub‚Ä¶";
        await new Promise(r => setTimeout(r, 5000));
        continue;
      }

      const phase  = (data.phase  || "").toLowerCase();
      const status = data.status || "";

      // If timestamp exists and is clearly older than when we opened the page,
      // treat this as stale status from a previous run and keep waiting.
      if (data.timestamp != null) {
        const tsNum = Number(data.timestamp);
        if (!Number.isNaN(tsNum)) {
          const tsMs = tsNum * 1000;
          if (tsMs < startedAt - 5000) {
            statusEl.textContent = "‚è≥ Waiting Processing‚Ä¶";
            await new Promise(r => setTimeout(r, 4000));
            continue;
          }
        }
      }

      if (/error/.test(phase) || /error/i.test(status)) {
        statusEl.innerHTML = `<span class="err">‚ùå ${status || "Error"}</span>`;
        stopAllTimers();   // leave timer+bar as-is
        return;
      }

      if (phase === "running" || phase === "csv_only" || phase === "analysis") {
        statusEl.textContent = status || "‚è≥ Running analysis‚Ä¶";
      } else if (phase === "publishing") {
        statusEl.textContent = status || "üöÄ Publishing results‚Ä¶";
      } else if (phase === "done") {
        const rel  = data.html || `analysis/${rawLabel}/${rawLabel}.analysis.html`;
        const href = `https://soazcomms.github.io/${rel.replace(/^\/+/,"")}`;

        viewBtn.removeAttribute("disabled");
        viewBtn.href = href;

        showDone(status || `‚úÖ Analysis complete!`);
        return;
      }

      await new Promise(r => setTimeout(r, 5000));
    }
  }

  // ---- start job via Cloudflare worker ----
  async function startJob(){
    if (!WORKER_URL) {
      statusEl.innerHTML = '<span class="err">‚ùå Worker URL not configured.</span>';
      return;
    }
    if (posted) return;
    posted = true;

    const payload = {
      label: rawLabel,
      from:  fromTxt,
      to:    toTxt,
      _cb:   cb
    };

    srvlog("worker_post", { url: WORKER_URL, payload });

    try {
      const resp = await fetch(WORKER_URL, {
        method: "POST",
        mode: "cors",
        cache: "no-store",
        credentials: "omit",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        const txt = await resp.text().catch(() => "");
        srvlog("worker_bad_status", { code: resp.status, body: txt });
        statusEl.innerHTML = `<span class="err">‚ùå Worker error (${resp.status}).</span>`;
        stopAllTimers();
        return;
      }

      const maybe = await resp.json().catch(() => ({}));
      srvlog("worker_ok", maybe);
      statusEl.textContent = "‚è≥ Running analysis via GitHub Actions‚Ä¶";
      pollLoop();

    } catch (e) {
      srvlog("worker_fetch_exception", { error: String(e) });
      statusEl.innerHTML = `<span class="err">‚ùå Failed to reach worker.</span>`;
      stopAllTimers();
    }
  }

  // kick things off
  statusEl.textContent = "‚è≥ Preparing‚Ä¶";
  startJob();

})();
</script>
</body>
</html>
