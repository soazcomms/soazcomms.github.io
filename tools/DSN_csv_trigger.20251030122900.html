<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<title>DSN CSV Export</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:20px;line-height:1.45}
  .wrap{max-width:780px}
  h1{margin:0 0 .5rem 0}
  .muted{color:#666}
  .row{margin:1rem 0}
  .btn{display:inline-block;padding:.6rem 1rem;border:1px solid #ddd;border-radius:8px;text-decoration:none;cursor:pointer}
  .btn.disabled{opacity:.5;pointer-events:none}
  .ok{color:#0a6}
  .err{color:#b00}
  /* your existing bar look */
  .bar{height:14px;background:#222;border-radius:7px;overflow:hidden;outline:2px solid #900}
  .bar>span{display:block;height:100%;width:0%;
            background:#ff1744;box-shadow:0 0 6px #ff1744,0 0 12px #ff1744;transition:width .45s ease}
  .done .bar>span{background:#18c37e;box-shadow:0 0 6px #18c37e,0 0 12px #18c37e}
  .hint{font-size:.9rem;color:#666}
</style>

<div class="wrap" id="wrap">
  <h1>DSN CSV Export</h1>
  <div class="muted" id="desc">Preparing‚Ä¶</div>

  <div class="row"><div class="bar"><span id="bar"></span></div></div>

  <div class="row">
    <a id="download" class="btn disabled" href="#">‚¨á Download CSV</a>
    <a id="viewlog" class="btn" target="_blank" rel="noopener" style="display:none;">ü™µ View log</a>
    <a id="retry" class="btn" href="#" style="display:none;">‚Üª Retry</a>
  </div>

  <div class="row muted" id="status">‚öôÔ∏è Working‚Ä¶</div>
  <div class="row hint" id="hint" style="display:none;"></div>
</div>

<script>
(() => {
  // ‚Äî‚Äî‚Äî constants ‚Äî‚Äî‚Äî
  const GH_PAGES_BASE = "https://soazcomms.github.io";
  const GH_RAW_BASE   = "https://raw.githubusercontent.com/soazcomms/soazcomms.github.io/main";

  // Update these two if your ngrok domain changes (keeps 8050 server-side).
  const WEBHOOK_URL   = "https://sound-kangaroo-unlikely.ngrok-free.app/DSN_csv";
  const CLEANUP_URL   = "https://sound-kangaroo-unlikely.ngrok-free.app/DSN_cleanup";

  // ‚Äî‚Äî‚Äî query + DOM ‚Äî‚Äî‚Äî
  const qs      = new URLSearchParams(location.search);
  const label   = (qs.get("label")||"").trim();
  const fromQ   = (qs.get("from") || "").trim();
  const toQ     = (qs.get("to")   || "").trim();
  const toYMD   = s => String(s).slice(0,10).replaceAll("/","-");
  const yFrom   = toYMD(fromQ), yTo = toYMD(toQ);
  const yFromC  = yFrom.replaceAll("-",""), yToC = yTo.replaceAll("-","");
  const safeLabel = (label||"").replace(/[^\w.\-]+/g, "_");

  const wrapEl  = document.getElementById("wrap");
  const statusEl= document.getElementById("status");
  const barEl   = document.getElementById("bar");
  const dlEl    = document.getElementById("download");
  const logEl   = document.getElementById("viewlog");
  const retryEl = document.getElementById("retry");
  const descEl  = document.getElementById("desc");
  const hintEl  = document.getElementById("hint");

  descEl.textContent = `Label: ${label} ¬∑ Range: ${yFrom} ‚Üí ${yTo}`;
  dlEl.classList.add("disabled"); dlEl.href = "#";

  // ‚Äî‚Äî‚Äî helpers ‚Äî‚Äî‚Äî
  const bust = u => u + (u.includes("?") ? "&" : "?") + "bust=" + Date.now();

  async function fetchOK(u){
    try{
      const r = await fetch(bust(u), { method:"GET", cache:"no-store", redirect:"follow" });
      return r.ok ? r : null;
    }catch{ return null; }
  }
  async function firstReachable(urls){
    for (const u of urls){
      const r = await fetchOK(u);
      if (r) return { url: u, resp: r };
    }
    return null;
  }
  async function reach404(u){
    try{ const r = await fetch(bust(u), { cache:"no-store", redirect:"follow" }); return r.status === 404; }
    catch { return false; }
  }
  async function forceDownload(urls, filename){
    for (const u of urls){
      try{
        const r = await fetch(bust(u), { method:"GET", cache:"no-store", redirect:"follow" });
        if (!r.ok) continue;
        const blob = await r.blob();
        const objectUrl = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = objectUrl; a.download = filename || "data.csv";
        document.body.appendChild(a); a.click();
        setTimeout(()=>{ URL.revokeObjectURL(objectUrl); a.remove(); }, 250);
        return true;
      }catch(_e){}
    }
    return false;
  }

  // progress ‚Üí 95% while waiting
  let pct=6, ticks=0, lastTs=0;
  barEl.style.width = pct + "%";
  const tTick=setInterval(()=>{ pct=Math.min(95,pct+1+Math.min(6,Math.floor(ticks/5))); barEl.style.width=pct+"%"; ticks++; }, 900);

  // Kick the server job (idempotent)
  fetch(WEBHOOK_URL,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({label,from:yFrom,to:yTo})})
    .then(()=>{ statusEl.textContent="Triggered‚Ä¶ generating CSV"; })
    .catch(()=>{ statusEl.textContent="Triggered (no response)"; });

  // Expected paths
  const statusRel   = `status/status-${safeLabel}.json`;
  const rawStatus   = `${GH_RAW_BASE}/${statusRel}`;
  const pagesStatus = `${GH_PAGES_BASE}/${statusRel}`;
  const expectedRel = `DSNdata/${safeLabel}_${yFromC}_${yToC}.csv`;
  const guessRAW    = `${GH_RAW_BASE}/${expectedRel}`;
  const guessPAGES  = `${GH_PAGES_BASE}/${expectedRel}`;

  async function getStatus() {
    try { const r=await fetch(bust(rawStatus),  {cache:"no-store"}); if (r.ok) return await r.json(); } catch {}
    try { const r=await fetch(bust(pagesStatus),{cache:"no-store"}); if (r.ok) return await r.json(); } catch {}
    return null;
  }

  async function resolveLogUrl(data){
    const guess = `logs/csv-${safeLabel}-${yFromC}-${yToC}.log`;
    const candidates = [];
    if (data && data.log_raw) candidates.push(String(data.log_raw));
    if (data && data.log){
      const l = String(data.log).replace(/^\/+/, "");
      candidates.push(/^https?:\/\//i.test(l) ? l : `${GH_RAW_BASE}/${l}`);
      candidates.push(/^https?:\/\//i.test(l) ? l : `${GH_PAGES_BASE}/${l}`);
    }
    candidates.push(`${GH_RAW_BASE}/${guess}`);
    candidates.push(`${GH_PAGES_BASE}/${guess}`);
    const hit = await firstReachable(candidates);
    return hit ? hit.url : null;
  }

  function wireDownload(finalRaw, finalPages){
    const pretty = `${label}_${yFrom}_${yTo}.csv`;
    dlEl.classList.remove("disabled");
    dlEl.removeAttribute("href");
    dlEl.onclick = async (e)=>{
      e.preventDefault();
      statusEl.textContent = "Preparing download‚Ä¶";
      const ok = await forceDownload([finalRaw, finalPages].filter(Boolean), pretty);
      if (!ok) { statusEl.textContent = "‚ö†Ô∏è Download failed: HTTP 404"; return; }

      // Cleanup after download
      statusEl.textContent = "üßπ Cleaning up‚Ä¶";
      const body = { label, from: yFrom, to: yTo };
      fetch(CLEANUP_URL, { method:"POST", headers:{"content-type":"application/json"}, body: JSON.stringify(body) })
        .then(r => r.json().then(j => ({ ok: r.ok, body: j })).catch(()=>({ok:r.ok, body:{}})))
        .then(async ({ ok, body })=>{
          if (!ok || body.push_ok === false) { statusEl.textContent = "‚ö†Ô∏è Cleanup push failed ‚Äî check git on server."; return; }
          // Poll both endpoints for 404 (disappeared)
          const rawU = finalRaw   || (finalPages ? finalPages.replace(GH_PAGES_BASE, GH_RAW_BASE) : "");
          const pgU  = finalPages || (finalRaw   ? finalRaw.replace(GH_RAW_BASE, GH_PAGES_BASE) : "");
          let sec=0, max=120;
          while (sec++ < max){
            const [goneRaw, gonePages] = await Promise.all([ reach404(rawU), reach404(pgU) ]);
            if ((rawU ? goneRaw : true) && (pgU ? gonePages : true)) { statusEl.textContent = "üßπ Cleaned up."; return; }
            statusEl.textContent = `üßπ Cleaning up‚Ä¶ (${sec}s)`;
            await new Promise(res => setTimeout(res, 1000));
          }
          statusEl.textContent = "‚ö†Ô∏è Cleanup pushed; CDN may still be serving cached file.";
        })
        .catch(()=>{ statusEl.textContent = "‚ö†Ô∏è Cleanup request failed (network)."; });
    };
  }

  function finish(finalRaw, finalPages){
    clearInterval(tPoll); clearInterval(tTick);
    barEl.style.width = "100%"; wrapEl.classList.add("done");
    statusEl.innerHTML = '<span class="ok">‚úÖ CSV ready.</span>';
    wireDownload(finalRaw, finalPages);
    hintEl.style.display = "block";
    hintEl.textContent = "If the browser blocks the first attempt, click Download again.";
  }

  function fail(msg){
    clearInterval(tPoll); clearInterval(tTick);
    barEl.style.width = "100%";
    statusEl.innerHTML = `<span class="err">‚ùå Failed.</span> ${msg||""}`;
    retryEl.style.display="inline-block";
    retryEl.onclick=(e)=>{ e.preventDefault(); location.reload(); };
  }

  // ‚Äî‚Äî‚Äî main poll ‚Äî‚Äî‚Äî
  const tPoll = setInterval(async ()=>{
    // Early hit: RAW guess
    const early = await fetchOK(guessRAW);
    if (early) { finish(guessRAW, guessPAGES); return; }

    const data = await getStatus();
    if (data) {
      // show log when reachable
      (async () => {
        const logUrl = await resolveLogUrl(data);
        if (logUrl){ logEl.href = bust(logUrl); logEl.style.display="inline-block"; }
      })();

      if (data.timestamp && data.timestamp !== lastTs) {
        lastTs = data.timestamp; pct = Math.min(97, pct+2); barEl.style.width = pct + "%";
      }

      // Build CSV URLs (prefer csv_raw if present)
      const rel = data.csv ? String(data.csv).replace(/^\/+/, "") : "";
      const rawAbs   = data.csv_raw ? String(data.csv_raw) : (rel ? `${GH_RAW_BASE}/${rel}`   : "");
      const pagesAbs = rel ? `${GH_PAGES_BASE}/${rel}` : "";

      // Choose whichever is live first
      const hit = await firstReachable([rawAbs, pagesAbs].filter(Boolean));
      if (hit) { finish(rawAbs || "", pagesAbs || ""); return; }

      const phase = String(data.phase||"").toLowerCase();
      if (phase === "error") { fail(data.status||""); return; }
      if (phase === "done"  && (rawAbs || pagesAbs)) { finish(rawAbs || "", pagesAbs || ""); return; }
    }

    statusEl.textContent = "‚öôÔ∏è Working‚Ä¶";
  }, 900);
})();
</script>
</html>

<!-- STAMP: DSN_csv_trigger 20251030122900 -->
<div id="stamp" style="position:fixed;right:8px;bottom:8px;font:12px/1.2 monospace;color:#999;">STAMP 20251030122900</div>
