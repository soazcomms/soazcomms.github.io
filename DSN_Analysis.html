
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Southern Arizona Dark Sky Network</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>ðŸŒŒ Southern Arizona Dark Sky Network</h1>
  <input type="file" id="fileInput" accept=".dat" />
  <p id="fileName"></p>
  <canvas id="msasHistogram" width="800" height="300"></canvas>
  <canvas id="jellyfish" width="800" height="300"></canvas>
  <canvas id="heatmap" width="800" height="300"></canvas>
  <canvas id="skyChart" width="800" height="300"></canvas>
  <canvas id="sigmaHistogram" width="800" height="300"></canvas>

  <script>
    const fromUnix = parseInt(new URLSearchParams(window.location.search).get("from"));
    const toUnix = parseInt(new URLSearchParams(window.location.search).get("to"));
    const fromDate = new Date(fromUnix);
    const toDate = new Date(toUnix);

    document.getElementById('fileInput').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) return;
      document.getElementById("fileName").innerText = file.name;

      const reader = new FileReader();
      reader.onload = function(e) {
        const lines = e.target.result.split('\n');
        const dataRows = lines.filter(line => line && !line.startsWith('#')).map(line => line.split(';'));
        const filtered = dataRows.filter(row => {
          try {
            const utc = new Date(row[0]);
            return utc >= fromDate && utc <= toDate;
          } catch {
            return false;
          }
        });

        // For now, just display MSAS histogram
        const msas = filtered.map(row => parseFloat(row[5])).filter(v => !isNaN(v));
        const bins = Array(40).fill(0);
        msas.forEach(v => {
          const bin = Math.min(39, Math.floor((v - 15) * 2));
          if (bin >= 0) bins[bin]++;
        });

        const ctx = document.getElementById("msasHistogram").getContext("2d");
        new Chart(ctx, {
          type: "bar",
          data: {
            labels: bins.map((_, i) => (15 + i * 0.5).toFixed(1)),
            datasets: [{
              label: "MSAS Histogram",
              data: bins
            }]
          },
          options: {
            responsive: true,
            scales: {
              x: { title: { display: true, text: "Mag/arcsecÂ²" } },
              y: { title: { display: true, text: "Count" } }
            }
          }
        });
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>
